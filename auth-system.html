<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>우리반 홈페이지</title>
    <meta property="og:title" content="우리반 홈페이지" />
    <meta property="og:description" content="우리반 홈페이지입니다" />
    <meta property="og:type" content="website" />
    <!-- Google Fonts: Nanum Gothic (둥글고 귀여운 한글 폰트) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet" />
    <style>
      /* ===========================
         전역 스타일 초기화 및 기본값
         =========================== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        /* 파스텔 라벤더/핑크 계열 프라이머리 색상 */
        --color-primary: #b48de8;
        --color-primary-hover: #9b6fd4;
        --color-primary-light: #f5eeff;
        /* 부드러운 파스텔 위험(danger) 색상 */
        --color-danger: #f08080;
        --color-danger-hover: #e06060;
        /* 파스텔 민트 성공(success) 색상 */
        --color-success: #6dcfb0;
        --color-success-light: #edfaf5;
        /* 파스텔 노란 경고(warning) 색상 */
        --color-warning: #f5c76a;
        --color-warning-light: #fffbee;
        /* 텍스트 색상 (다소 부드럽게) */
        --color-text-primary: #3d3250;
        --color-text-secondary: #8878a8;
        --color-text-muted: #bbadd4;
        /* 테두리 & 배경 */
        --color-border: #e8d9f8;
        --color-bg: #fdf7ff;
        --color-surface: #ffffff;
        /* 은은하고 부드러운 그림자 */
        --shadow-sm: 0 2px 8px rgba(180, 141, 232, 0.12);
        --shadow-md: 0 6px 20px rgba(180, 141, 232, 0.18);
        --shadow-lg: 0 12px 36px rgba(180, 141, 232, 0.22);
        /* 더 둥근 모서리 */
        --radius-sm: 14px;
        --radius-md: 20px;
        --radius-lg: 28px;
        --transition: 0.2s ease;
      }

      body {
        /* Nanum Gothic 우선 적용, 미지원 시 폴백 */
        font-family: 'Nanum Gothic', 'Apple SD Gothic Neo', '맑은 고딕', sans-serif;
        background: var(--color-bg);
        /* 연한 라벤더 그라디언트 배경 */
        background-image: radial-gradient(ellipse at top left, #f0e6ff 0%, #fdf7ff 50%, #e8f8f5 100%);
        background-attachment: fixed;
        color: var(--color-text-primary);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 32px 24px 60px;
        letter-spacing: 0.01em;
      }

      /* ===========================
         메인 컨테이너
         =========================== */
      .app-container {
        width: 100%;
        max-width: 520px;
        transition: max-width 0.25s ease;
      }

      /* 로그인 후 화면은 넓게 */
      .app-container.wide {
        max-width: 900px;
      }

      /* 앱 헤더 영역 */
      .app-header {
        margin-bottom: 32px;
        text-align: center;
      }

      .app-header .header-icon {
        font-size: 2.8rem;
        margin-bottom: 12px;
        display: block;
      }

      .app-header h1 {
        font-size: 1.9rem;
        font-weight: 800;
        color: var(--color-primary);
        /* 귀여운 느낌을 위해 자간 살짝 넓힘 */
        letter-spacing: 0.04em;
      }

      .app-header p {
        margin-top: 8px;
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        line-height: 1.6;
      }

      /* ===========================
         화면 전환 애니메이션
         =========================== */
      .screen {
        display: none;
      }

      .screen.active {
        display: block;
        animation: fadeSlideIn 0.22s ease;
      }

      @keyframes fadeSlideIn {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      /* ===========================
         카드 컴포넌트 (공통)
         =========================== */
      .card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        /* 파스텔 라벤더 테두리로 귀여운 윤곽선 */
        border: 1.5px solid var(--color-border);
        overflow: hidden;
      }

      .card + .card {
        margin-top: 16px;
      }

      .card-header {
        padding: 20px 24px 16px;
        border-bottom: 1.5px solid var(--color-border);
        /* 라벤더 그라디언트 카드 헤더 */
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
      }

      .card-header h2 {
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--color-primary);
      }

      .card-header p {
        margin-top: 4px;
        font-size: 0.83rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
      }

      .card-body {
        padding: 24px;
      }

      /* ===========================
         폼 요소 (공통)
         =========================== */
      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        border: 2px solid var(--color-border);
        /* 입력창도 둥글게 */
        border-radius: var(--radius-sm);
        padding: 13px 16px;
        font-size: 1rem;
        color: var(--color-text-primary);
        outline: none;
        transition: border-color var(--transition), box-shadow var(--transition);
        background: #fdf7ff;
        font-family: inherit;
        letter-spacing: 0.02em;
        appearance: none;
        -webkit-appearance: none;
      }

      .form-input::placeholder,
      .form-textarea::placeholder {
        color: var(--color-text-muted);
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        border-color: var(--color-primary);
        /* 라벤더 포커스 글로우 */
        box-shadow: 0 0 0 4px rgba(180, 141, 232, 0.22);
        background: var(--color-surface);
      }

      /* 날짜 선택기 (date picker) 귀여운 테마 */
      input[type="date"] {
        font-family: 'Nanum Gothic', 'Apple SD Gothic Neo', '맑은 고딕', sans-serif;
        color-scheme: light;
      }

      input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        border-radius: 6px;
        padding: 3px;
        transition: background 0.15s ease;
        filter: invert(45%) sepia(60%) saturate(500%) hue-rotate(230deg);
      }

      input[type="date"]::-webkit-calendar-picker-indicator:hover {
        background: rgba(180, 141, 232, 0.15);
      }

      input[type="date"]::-webkit-datetime-edit {
        font-family: 'Nanum Gothic', sans-serif;
        font-weight: 600;
        color: var(--color-text-primary);
      }

      input[type="date"]::-webkit-datetime-edit-fields-wrapper {
        font-family: 'Nanum Gothic', sans-serif;
      }

      input[type="date"]::-webkit-datetime-edit-year-field,
      input[type="date"]::-webkit-datetime-edit-month-field,
      input[type="date"]::-webkit-datetime-edit-day-field {
        color: var(--color-primary);
        font-weight: 700;
      }

      input[type="date"]::-webkit-datetime-edit-year-field:focus,
      input[type="date"]::-webkit-datetime-edit-month-field:focus,
      input[type="date"]::-webkit-datetime-edit-day-field:focus {
        background: var(--color-primary-light);
        border-radius: 4px;
        color: var(--color-primary-hover);
      }

      input[type="date"]::-webkit-datetime-edit-text {
        color: var(--color-text-muted);
      }

      /* 텍스트영역 전용 */
      .form-textarea {
        resize: vertical;
        min-height: 80px;
        line-height: 1.6;
      }

      /* 드롭다운 화살표 커스텀 */
      .form-select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        padding-right: 44px;
        cursor: pointer;
      }

      /* 드롭다운 행 레이아웃 (학년 + 반 나란히) */
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .form-row .form-group {
        margin-bottom: 0;
      }

      /* ===========================
         버튼 컴포넌트 (공통)
         =========================== */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: none;
        /* 버튼을 pill형으로 (매우 둥글게) */
        border-radius: 999px;
        padding: 13px 24px;
        font-size: 0.97rem;
        font-weight: 700;
        cursor: pointer;
        transition: background var(--transition), transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow var(--transition);
        font-family: inherit;
        white-space: nowrap;
        letter-spacing: 0.03em;
      }

      /* 호버 시 살짝 위로 튀어오르는 효과 */
      .btn:hover {
        transform: translateY(-2px) scale(1.03);
      }

      .btn:active {
        transform: scale(0.96);
      }

      .btn--full {
        width: 100%;
      }

      /* 기본(primary) 버튼 — 파스텔 라벤더 그라디언트 */
      .btn--primary {
        background: linear-gradient(135deg, #c9a6f0 0%, #b48de8 100%);
        color: #fff;
        box-shadow: 0 4px 14px rgba(180, 141, 232, 0.35);
      }

      .btn--primary:hover {
        background: linear-gradient(135deg, #b48de8 0%, #9b6fd4 100%);
        box-shadow: 0 6px 20px rgba(180, 141, 232, 0.45);
      }

      /* 보조(secondary) 버튼 — 파스텔 테두리 */
      .btn--secondary {
        background: var(--color-surface);
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
      }

      .btn--secondary:hover {
        background: var(--color-primary-light);
      }

      /* 위험(danger) 버튼 — 부드러운 파스텔 레드 */
      .btn--danger {
        background: none;
        color: var(--color-danger);
        border: 2px solid var(--color-danger);
      }

      .btn--danger:hover {
        /* 연한 파스텔 핑크 호버 */
        background: #fde8e8;
      }

      .btn--warning {
        background: none;
        color: #a07800;
        border: 2px solid var(--color-warning);
      }

      .btn--warning:hover {
        background: #fffbee;
      }

      /* 고스트(ghost) 버튼 — 텍스트만 */
      .btn--ghost {
        background: none;
        color: var(--color-text-secondary);
        padding: 8px 16px;
        font-size: 0.88rem;
        border-radius: 999px;
      }

      .btn--ghost:hover {
        color: var(--color-primary);
        background: var(--color-primary-light);
      }

      /* 성공(success) 버튼 — 파스텔 민트 */
      .btn--success {
        background: linear-gradient(135deg, #84dbbe 0%, #6dcfb0 100%);
        color: #fff;
        box-shadow: 0 4px 14px rgba(109, 207, 176, 0.35);
      }

      .btn--success:hover {
        background: linear-gradient(135deg, #6dcfb0 0%, #52bfa0 100%);
        box-shadow: 0 6px 20px rgba(109, 207, 176, 0.45);
      }

      /* 텍스트 링크 버튼 */
      .btn--link {
        background: none;
        border: none;
        color: var(--color-primary);
        font-size: 0.88rem;
        font-weight: 600;
        padding: 4px 0;
        cursor: pointer;
        text-decoration: underline;
        font-family: inherit;
      }

      .btn--link:hover {
        color: var(--color-primary-hover);
      }

      /* 작은 버튼 */
      .btn--sm {
        padding: 8px 14px;
        font-size: 0.83rem;
      }

      /* ===========================
         알림 메시지 박스
         =========================== */
      .alert {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px 16px;
        border-radius: var(--radius-sm);
        font-size: 0.88rem;
        line-height: 1.5;
        margin-bottom: 16px;
        animation: fadeSlideIn 0.18s ease;
      }

      .alert--error {
        /* 파스텔 핑크 에러 */
        background: #fdeaea;
        color: #c05050;
        border: 1px solid #f5b0b0;
        border-radius: var(--radius-sm);
      }

      .alert--success {
        /* 파스텔 민트 성공 */
        background: var(--color-success-light);
        color: #2e8a6e;
        border: 1px solid #a8e8d4;
        border-radius: var(--radius-sm);
      }

      .alert--warning {
        /* 파스텔 노랑 경고 */
        background: var(--color-warning-light);
        color: #9a6a00;
        border: 1px solid #f5d88a;
        border-radius: var(--radius-sm);
      }

      .alert--info {
        background: var(--color-primary-light);
        color: var(--color-primary);
        border: 1px solid #dcc8f5;
        border-radius: var(--radius-sm);
      }

      .alert-icon {
        font-size: 1rem;
        flex-shrink: 0;
        margin-top: 1px;
      }

      /* ===========================
         메인 화면 — 역할 선택
         =========================== */
      .role-select-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin-top: 8px;
      }

      .role-card {
        background: var(--color-surface);
        border-radius: var(--radius-md);
        padding: 24px 12px;
        text-align: center;
        border: 2px solid var(--color-border);
        cursor: pointer;
        transition:
          border-color var(--transition),
          box-shadow var(--transition),
          background var(--transition),
          /* 튀는 스프링 효과 */
          transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: var(--shadow-sm);
      }

      .role-card:hover {
        border-color: var(--color-primary);
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
        transform: translateY(-4px) scale(1.03);
      }

      .role-card:active {
        transform: translateY(0) scale(0.97);
      }

      .role-card-icon {
        font-size: 2.2rem;
        margin-bottom: 10px;
        display: block;
      }

      .role-card-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-text-primary);
        margin-bottom: 5px;
      }

      .role-card-desc {
        font-size: 0.74rem;
        color: var(--color-text-secondary);
        line-height: 1.5;
      }

      /* ===========================
         사용자 홈 화면 — 프로필 카드
         =========================== */
      .profile-icon-wrap {
        width: 96px;
        height: 96px;
        /* 파스텔 라벤더→핑크 그라디언트 아이콘 배경 */
        background: linear-gradient(135deg, #f0e0ff 0%, #fce8f8 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 2.6rem;
        border: 3px solid #dcc8f5;
        box-shadow: 0 6px 18px rgba(180, 141, 232, 0.22);
        animation: popIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes popIn {
        from { opacity: 0; transform: scale(0.5); }
        to   { opacity: 1; transform: scale(1); }
      }

      .welcome-title {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--color-primary);
        text-align: center;
        margin-bottom: 6px;
      }

      .welcome-subtitle {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        text-align: center;
        margin-bottom: 24px;
      }

      /* 사용자 정보 테이블 (홈 화면) */
      .info-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 24px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--color-border);
      }

      .info-table th,
      .info-table td {
        padding: 12px 16px;
        font-size: 0.92rem;
        text-align: left;
        border-bottom: 1px solid var(--color-border);
      }

      .info-table tr:last-child th,
      .info-table tr:last-child td {
        border-bottom: none;
      }

      .info-table th {
        font-weight: 700;
        color: var(--color-text-secondary);
        /* 파스텔 라벤더 테이블 헤더 */
        background: #f5eeff;
        width: 35%;
      }

      .info-table td {
        color: var(--color-text-primary);
        font-weight: 600;
      }

      /* ===========================
         사용자 홈 — 통합 상단 네비게이션 바
         =========================== */
      .user-navbar {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        background: var(--color-surface);
        border-radius: var(--radius-md);
        border: 1.5px solid var(--color-border);
        box-shadow: var(--shadow-sm);
        position: relative;
        z-index: 100;
      }

      /* 왼쪽 탭 영역 */
      .user-navbar-tabs {
        display: flex;
        flex: 1;
        min-width: 0;
      }

      .user-navbar-tabs button {
        padding: 14px 16px;
        font-size: 0.88rem;
        font-weight: 700;
        font-family: inherit;
        border: none;
        cursor: pointer;
        transition: background var(--transition), color var(--transition);
        background: transparent;
        color: var(--color-text-muted);
        letter-spacing: 0.02em;
        white-space: nowrap;
        position: relative;
      }

      .user-navbar-tabs button:hover {
        background: var(--color-primary-light);
        color: var(--color-primary);
      }

      .user-navbar-tabs button.active {
        color: var(--color-primary);
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
      }

      .user-navbar-tabs button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 16%;
        width: 68%;
        height: 3px;
        background: var(--color-primary);
        border-radius: 3px 3px 0 0;
      }

      /* 우리반(홈) 버튼 — 약간 특별하게 */
      .user-navbar-tabs .nav-home {
        font-weight: 800;
        color: var(--color-primary);
      }

      .user-navbar-tabs .nav-home:hover {
        background: var(--color-primary-light);
      }

      /* 오른쪽 사용자 영역 */
      .user-navbar-user {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-left: 1.5px solid var(--color-border);
        flex-shrink: 0;
      }

      /* 드롭다운 화살표 버튼 */
      .navbar-dropdown-wrap {
        position: relative;
      }

      .btn-dropdown-arrow {
        background: var(--color-primary-light);
        border: 1.5px solid var(--color-border);
        border-radius: 8px;
        padding: 3px 8px;
        font-size: 0.65rem;
        color: var(--color-primary);
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s ease;
      }

      .btn-dropdown-arrow:hover {
        background: var(--color-primary);
        color: #fff;
      }

      .btn-dropdown-arrow.open {
        background: var(--color-primary);
        color: #fff;
      }

      /* 드롭다운 메뉴 */
      .navbar-dropdown {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        right: 0;
        background: #fff;
        border: 1.5px solid var(--color-border);
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        min-width: 160px;
        z-index: 99999;
        overflow: hidden;
      }

      .navbar-dropdown.open {
        display: block;
      }

      .navbar-dropdown .dropdown-item {
        display: block;
        width: 100%;
        padding: 10px 16px;
        background: none;
        border: none;
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--color-text-primary);
        cursor: pointer;
        font-family: inherit;
        text-align: left;
        transition: background 0.12s ease;
      }

      .navbar-dropdown .dropdown-item:hover {
        background: var(--color-primary-light);
      }

      .navbar-dropdown .dropdown-item + .dropdown-item {
        border-top: 1px solid var(--color-border);
      }

      /* 사용자 정보 패널 */
      .profile-panel {
        background: #fff;
        border: 1.5px solid var(--color-border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        margin: 0 0 16px;
        overflow: hidden;
      }

      .profile-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 20px;
        background: var(--color-primary-light);
        border-bottom: 1.5px solid var(--color-border);
      }

      .profile-panel-header h3 {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--color-primary);
        margin: 0;
      }

      .btn-profile-close {
        background: none;
        border: none;
        font-size: 1.1rem;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 6px;
        transition: all 0.12s ease;
      }

      .btn-profile-close:hover {
        background: var(--color-danger);
        color: #fff;
      }

      .profile-panel-body {
        padding: 16px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .user-navbar-user .navbar-username {
        font-size: 0.82rem;
        font-weight: 700;
        color: var(--color-text-primary);
        white-space: nowrap;
      }

      .user-navbar-user .btn--logout-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background var(--transition);
        width: 30px;
        height: 30px;
        flex-shrink: 0;
      }

      .user-navbar-user .btn--logout-icon:hover {
        background: #fce8e8;
      }

      /* 로그아웃 아이콘 (CSS로 문 나가는 모양) */
      .user-navbar-user .btn--logout-icon svg {
        width: 18px;
        height: 18px;
        stroke: var(--color-danger);
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .user-tab-content {
        display: none;
      }

      .user-tab-content.active {
        display: block;
        animation: fadeSlideIn 0.22s ease;
      }

      /* 모바일 반응형 — 작은 화면에서 폰트 축소 */
      @media (max-width: 480px) {
        .user-navbar-tabs button {
          padding: 12px 10px;
          font-size: 0.78rem;
        }
        .user-navbar-user {
          padding: 8px 10px;
        }
        .user-navbar-user .navbar-username {
          font-size: 0.75rem;
        }
      }

      /* ===========================
         다이어리 스타일 레이아웃 (시간대별 한줄평)
         =========================== */
      .diary-layout {
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1.5px solid var(--color-border);
        background: var(--color-surface);
      }

      /* 상단 월/연도 헤더 */
      .diary-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 18px 22px 14px;
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
        border-bottom: 1.5px solid var(--color-border);
      }

      .diary-nav-btn {
        background: none;
        border: 1.5px solid var(--color-border);
        border-radius: 10px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--color-primary);
        font-size: 1rem;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .diary-nav-btn:hover {
        background: var(--color-primary);
        color: #fff;
        border-color: var(--color-primary);
      }

      .diary-nav-btn:disabled {
        opacity: 0.3;
        cursor: default;
        pointer-events: none;
      }

      .diary-header .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
      }

      .diary-header .btn-today {
        margin-left: auto;
        background: var(--color-primary-light);
        border: 1.5px solid var(--color-border);
        border-radius: 10px;
        padding: 5px 14px;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--color-primary);
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }

      .diary-header .btn-today:hover {
        background: var(--color-primary);
        color: #fff;
      }

      .diary-header .btn-today.hidden {
        display: none;
      }

      .diary-header .month-num {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--color-primary);
        line-height: 1;
      }

      .diary-header .month-detail {
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .diary-header .month-eng {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--color-primary);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        line-height: 1.2;
      }

      .diary-header .month-year {
        font-size: 0.72rem;
        font-weight: 600;
        color: var(--color-text-muted);
        line-height: 1.2;
      }

      /* 알림 메시지 영역 */
      .diary-alert-wrap {
        padding: 0 22px;
      }

      /* ===========================
         가로 날짜 스트립
         =========================== */
      .diary-date-strip-wrap {
        padding: 10px 0 6px;
        border-bottom: 1.5px solid var(--color-border);
        background: #fdf8ff;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: #e0cfe8 transparent;
      }

      .diary-date-strip-wrap::-webkit-scrollbar {
        height: 4px;
      }
      .diary-date-strip-wrap::-webkit-scrollbar-track {
        background: transparent;
      }
      .diary-date-strip-wrap::-webkit-scrollbar-thumb {
        background: #e0cfe8;
        border-radius: 4px;
      }

      .diary-date-strip {
        display: flex;
        gap: 4px;
        padding: 0 14px;
        width: max-content;
        min-width: 100%;
      }

      /* 개별 날짜 버튼 */
      .diary-date-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        width: 36px;
        min-width: 36px;
        padding: 5px 0;
        border-radius: 10px;
        border: 1.5px solid transparent;
        background: transparent;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s ease;
      }

      .diary-date-btn .strip-dow {
        font-size: 0.6rem;
        font-weight: 700;
        color: var(--color-text-muted);
        letter-spacing: 0.02em;
      }

      .diary-date-btn .strip-day {
        font-size: 0.88rem;
        font-weight: 700;
        color: var(--color-text-primary);
        line-height: 1;
      }

      /* 토요일 파란색 */
      .diary-date-btn.is-sat .strip-dow,
      .diary-date-btn.is-sat .strip-day {
        color: #4a90d9;
      }

      /* 일요일 빨간색 */
      .diary-date-btn.is-sun .strip-dow,
      .diary-date-btn.is-sun .strip-day {
        color: #e55050;
      }

      /* 오늘 날짜 — 보라색(primary) 배경 */
      .diary-date-btn.is-today-date {
        background: var(--color-primary);
        border-color: var(--color-primary);
      }

      .diary-date-btn.is-today-date .strip-dow,
      .diary-date-btn.is-today-date .strip-day {
        color: #fff;
      }

      /* 선택된 날짜 (오늘과 구분: 테두리 + 연보라 배경) */
      .diary-date-btn.is-selected:not(.is-today-date) {
        background: #ede0ff;
        border-color: var(--color-primary);
      }

      .diary-date-btn.is-selected:not(.is-today-date) .strip-dow,
      .diary-date-btn.is-selected:not(.is-today-date) .strip-day {
        color: var(--color-primary);
      }

      .diary-date-btn:not(.is-today-date):not(.is-selected):hover {
        background: #f5eeff;
        border-color: var(--color-border);
      }

      /* ===========================
         선택 날짜 정보 영역
         =========================== */
      .diary-date-info {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 22px 10px;
        border-bottom: 1.5px solid var(--color-border);
        background: #faf5ff;
      }

      .diary-date-info .info-day-num {
        font-size: 3rem;
        font-weight: 900;
        color: var(--color-primary);
        line-height: 1;
        letter-spacing: -0.03em;
      }

      .diary-date-info .info-right {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .diary-date-info .info-dow {
        font-size: 1rem;
        font-weight: 700;
        color: var(--color-text-primary);
        line-height: 1.2;
      }

      .diary-date-info .info-dow.is-sat { color: #4a90d9; }
      .diary-date-info .info-dow.is-sun { color: #e55050; }

      .diary-date-info .info-lunar {
        font-size: 0.72rem;
        font-weight: 500;
        color: var(--color-text-muted);
        line-height: 1.2;
      }

      /* ===========================
         시간대별 행 목록
         =========================== */
      .diary-hour-rows {
        display: flex;
        flex-direction: column;
      }

      /* 개별 시간대 행 */
      .diary-hour-row {
        display: flex;
        align-items: stretch;
        border-bottom: 1px solid #f0e4fa;
        min-height: 40px;
      }

      .diary-hour-row:last-child {
        border-bottom: none;
      }

      /* 왼쪽 시간 칸 */
      .diary-hour-row .hour-cell {
        width: 46px;
        min-width: 46px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.72rem;
        font-weight: 700;
        color: var(--color-text-muted);
        background: #faf5ff;
        border-right: 1.5px solid #f0e4fa;
        flex-shrink: 0;
        user-select: none;
        letter-spacing: 0.02em;
      }

      /* 오른쪽 내용 칸 */
      .diary-hour-row .hour-content-cell {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 5px 12px;
        min-height: 40px;
        gap: 8px;
      }

      /* 오늘 선택 시 입력 가능한 행 */
      .diary-hour-row.is-editable .hour-content-cell {
        background: #f9f2ff;
      }

      /* 인라인 입력 필드 */
      .diary-hour-row .review-inline-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-family: inherit;
        font-size: 0.86rem;
        color: var(--color-text-primary);
        padding: 4px 0;
        min-width: 0;
      }

      .diary-hour-row .review-inline-input::placeholder {
        color: var(--color-text-muted);
        font-size: 0.78rem;
      }

      /* 저장 버튼 */
      .diary-hour-row .btn-save-inline {
        flex-shrink: 0;
        background: var(--color-primary);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 5px 12px;
        font-size: 0.73rem;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
        transition: background 0.15s ease;
        white-space: nowrap;
      }

      .diary-hour-row .btn-save-inline:hover {
        background: var(--color-primary-hover);
      }

      /* 작성된 한줄평 텍스트 */
      .diary-hour-row .review-text {
        font-size: 0.84rem;
        color: var(--color-text-primary);
        line-height: 1.5;
        word-break: break-all;
        flex: 1;
      }

      /* 빈 칸 표시 */
      .diary-hour-row .review-empty {
        font-size: 0.75rem;
        color: #e8dcf5;
        font-style: italic;
        user-select: none;
      }

      /* ===========================
         하단 한줄평 작성 섹션
         =========================== */
      .diary-review-section {
        border-top: 2px solid var(--color-border);
        padding: 16px 22px 20px;
        background: linear-gradient(135deg, #fef9ff 0%, #fdf0f8 100%);
      }

      .diary-review-section .review-section-title {
        font-size: 0.78rem;
        font-weight: 700;
        color: var(--color-primary);
        margin-bottom: 8px;
        letter-spacing: 0.03em;
      }

      .diary-review-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .diary-review-row .review-daily-input {
        flex: 1;
        border: 1.5px solid var(--color-border);
        border-radius: 10px;
        padding: 9px 14px;
        font-size: 0.88rem;
        font-family: inherit;
        background: #fff;
        color: var(--color-text-primary);
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
      }

      .diary-review-row .review-daily-input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(180, 141, 232, 0.18);
      }

      .diary-review-row .review-daily-input::placeholder {
        color: #d4c6e8;
        font-size: 0.82rem;
      }

      /* 한줄평 등록 버튼 */
      .btn-review-submit {
        background: var(--color-primary);
        border: none;
        border-radius: 10px;
        padding: 7px 16px;
        font-size: 0.82rem;
        font-weight: 700;
        color: #fff;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s ease;
        flex-shrink: 0;
        white-space: nowrap;
      }

      .btn-review-submit:hover {
        background: var(--color-primary-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(180, 141, 232, 0.3);
      }

      .btn-review-submit:active {
        transform: translateY(0);
      }

      /* 코멘트 버튼 */
      .btn-comment-view {
        background: #fffbee;
        border: 1.5px solid #f5c76a;
        border-radius: 10px;
        padding: 7px 12px;
        font-size: 0.75rem;
        font-weight: 700;
        color: #a07800;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.15s ease;
        flex-shrink: 0;
        white-space: nowrap;
      }

      .btn-comment-view:hover {
        background: #f5c76a;
        color: #fff;
        border-color: #e6b055;
      }

      .btn-comment-view.no-comment {
        opacity: 0.4;
        cursor: default;
        pointer-events: none;
      }

      /* 코멘트 메모지 팝오버 */
      .comment-memo-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        z-index: 999;
      }

      .comment-memo {
        position: absolute;
        z-index: 1000;
        width: 220px;
        padding: 14px 16px;
        background: #fffde6;
        border: 1.5px solid #f5c76a;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
        font-family: inherit;
        animation: memoFadeIn 0.15s ease;
      }

      @keyframes memoFadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .comment-memo .memo-label {
        font-size: 0.7rem;
        font-weight: 700;
        color: #a07800;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .comment-memo .memo-content {
        font-size: 0.84rem;
        color: #5a4200;
        line-height: 1.6;
        word-break: break-all;
      }

      .comment-memo .memo-date {
        font-size: 0.65rem;
        color: #b89a40;
        margin-top: 8px;
        text-align: right;
      }

      /* 모바일 반응형 */
      @media (max-width: 480px) {
        .diary-header {
          padding: 14px 16px 10px;
        }

        .diary-header .month-num {
          font-size: 1.8rem;
        }

        .diary-date-info {
          padding: 10px 14px 8px;
          gap: 10px;
        }

        .diary-date-info .info-day-num {
          font-size: 2.4rem;
        }

        .diary-date-info .info-dow {
          font-size: 0.88rem;
        }

        .diary-hour-row .hour-cell {
          width: 38px;
          min-width: 38px;
          font-size: 0.68rem;
        }

        .diary-hour-row .hour-content-cell {
          padding: 4px 8px;
        }

        .diary-hour-row .review-inline-input {
          font-size: 0.8rem;
        }

        .diary-hour-row .btn-save-inline {
          padding: 4px 8px;
          font-size: 0.68rem;
        }
      }

      /* ===========================
         한줄평 작성 섹션 (사용자 홈)
         =========================== */
      .review-write-section {
        margin-bottom: 0;
      }

      /* 오늘 날짜 표시 뱃지 — 파스텔 pill 스타일 */
      .today-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #f0e0ff 0%, #fce8f8 100%);
        color: var(--color-primary);
        font-size: 0.8rem;
        font-weight: 700;
        padding: 6px 16px;
        border-radius: 999px;
        margin-bottom: 12px;
        border: 1.5px solid #dcc8f5;
        box-shadow: 0 2px 8px rgba(180, 141, 232, 0.15);
      }

      /* 한줄평 입력 영역 + 버튼 묶음 */
      .review-input-wrap {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .review-char-count {
        font-size: 0.78rem;
        color: var(--color-text-muted);
        text-align: right;
        margin-top: -6px;
      }

      .review-char-count.near-limit {
        color: var(--color-warning);
      }

      .review-char-count.at-limit {
        color: var(--color-danger);
      }

      /* ===========================
         내 한줄평 목록 (사용자 홈)
         =========================== */
      .review-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* 개별 한줄평 아이템 */
      .review-item {
        border: 1.5px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: box-shadow var(--transition), transform var(--transition);
      }

      .review-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .review-item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        /* 파스텔 라벤더 헤더 */
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
        border-bottom: 1.5px solid var(--color-border);
      }

      .review-item-date {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--color-text-secondary);
      }

      /* 오늘 날짜 강조 */
      .review-item-date.is-today {
        color: var(--color-primary);
      }

      .review-item-body {
        padding: 12px 14px;
      }

      .review-item-content {
        font-size: 0.95rem;
        color: var(--color-text-primary);
        line-height: 1.7;
        word-break: break-all;
      }

      /* 관리자 평가 코멘트 표시 영역 — 파스텔 노랑 */
      .admin-comment-box {
        margin-top: 10px;
        padding: 10px 14px;
        background: #fffbee;
        border-radius: var(--radius-sm);
        border-left: 4px solid #f5c76a;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .admin-comment-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: #a07800;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .admin-comment-text {
        font-size: 0.88rem;
        color: #7a5a00;
        line-height: 1.6;
        word-break: break-all;
      }

      /* 한줄평 없음 안내 */
      .review-list-empty {
        text-align: center;
        padding: 28px 16px;
        color: var(--color-text-muted);
        font-size: 0.88rem;
        line-height: 1.8;
      }

      .review-list-empty-icon {
        font-size: 1.8rem;
        display: block;
        margin-bottom: 8px;
      }

      /* ===========================
         관리자 대시보드 — 사용자 목록 테이블
         =========================== */
      .section-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--color-text-secondary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .user-count-badge {
        /* 파스텔 라벤더 배지 */
        background: linear-gradient(135deg, #c9a6f0 0%, #b48de8 100%);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 3px 12px;
        border-radius: 999px;
        letter-spacing: 0.03em;
        box-shadow: 0 2px 8px rgba(180, 141, 232, 0.3);
      }

      .user-list-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.88rem;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--color-border);
      }

      .user-list-table thead tr {
        /* 파스텔 그라디언트 테이블 헤더 */
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
      }

      .user-list-table th {
        padding: 10px 14px;
        font-weight: 700;
        color: var(--color-primary);
        text-align: left;
        border-bottom: 2px solid #dcc8f5;
        white-space: nowrap;
      }

      .user-list-table td {
        padding: 10px 14px;
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-border);
      }

      .user-list-table tbody tr:last-child td {
        border-bottom: none;
      }

      .user-list-table tbody tr:hover {
        /* 호버 시 연한 파스텔 */
        background: #f9f2ff;
      }

      /* 사용자 없음 안내 */
      .user-list-empty {
        text-align: center;
        padding: 32px 16px;
        color: var(--color-text-muted);
        font-size: 0.88rem;
        line-height: 1.8;
      }

      .user-list-empty-icon {
        font-size: 2rem;
        display: block;
        margin-bottom: 8px;
      }

      /* ===========================
         관리자 한줄평 관리 섹션
         =========================== */

      /* 날짜 선택 행 */
      .date-filter-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }

      .date-filter-row .form-input {
        flex: 1;
        padding: 10px 14px;
        font-size: 0.9rem;
        background: linear-gradient(135deg, #fdf7ff 0%, #fce8f8 100%);
        color: var(--color-primary);
        font-weight: 600;
      }

      /* 관리자용 한줄평 목록 */
      .admin-review-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* 관리자용 한줄평 아이템 */
      .admin-review-item {
        border: 1.5px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: box-shadow var(--transition);
      }

      .admin-review-item:hover {
        box-shadow: var(--shadow-sm);
      }

      .admin-review-item-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        /* 파스텔 그라디언트 헤더 */
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
        border-bottom: 1.5px solid var(--color-border);
      }

      .admin-review-user-badge {
        /* 파스텔 라벤더 사용자 배지 */
        background: linear-gradient(135deg, #c9a6f0 0%, #b48de8 100%);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 12px;
        border-radius: 999px;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(180, 141, 232, 0.3);
      }

      /* 관리자 한줄평 목록 — 시간대 뱃지 */
      .admin-review-hour-badge {
        background: #fce8f8;
        color: var(--color-primary);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 3px 9px;
        border-radius: 999px;
        border: 1px solid #dcc8f5;
        white-space: nowrap;
        margin-left: 6px;
      }

      .admin-review-item-body {
        padding: 12px 14px;
      }

      .admin-review-content {
        font-size: 0.95rem;
        color: var(--color-text-primary);
        line-height: 1.7;
        margin-bottom: 12px;
        word-break: break-all;
      }

      /* 관리자 평가 입력 행 */
      .admin-comment-input-row {
        display: flex;
        gap: 8px;
        align-items: flex-start;
      }

      .admin-comment-input-row .form-input {
        flex: 1;
        padding: 9px 12px;
        font-size: 0.88rem;
      }

      /* 이미 평가가 있는 경우 표시 영역 — 파스텔 민트 */
      .existing-comment-box {
        margin-bottom: 10px;
        padding: 9px 12px;
        background: #edfaf5;
        border-radius: var(--radius-sm);
        border-left: 4px solid #6dcfb0;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .existing-comment-label {
        font-size: 0.75rem;
        font-weight: 700;
        color: #2e8a6e;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .existing-comment-text {
        font-size: 0.88rem;
        color: #1e6655;
        line-height: 1.6;
        word-break: break-all;
      }

      /* 한줄평 없음 안내 (관리자) */
      .admin-review-empty {
        text-align: center;
        padding: 32px 16px;
        color: var(--color-text-muted);
        font-size: 0.88rem;
        line-height: 1.8;
      }

      .admin-review-empty-icon {
        font-size: 2rem;
        display: block;
        margin-bottom: 8px;
      }

      /* 한줄평 수 뱃지 (관리자) — 파스텔 민트 */
      .review-count-badge {
        background: linear-gradient(135deg, #84dbbe 0%, #6dcfb0 100%);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 3px 12px;
        border-radius: 999px;
        letter-spacing: 0.03em;
        box-shadow: 0 2px 8px rgba(109, 207, 176, 0.3);
      }

      /* ===========================
         대시보드 상단 헤더 (관리자용)
         =========================== */
      .dashboard-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
        padding: 0 4px;
      }

      .dashboard-topbar h2 {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--color-text-primary);
      }

      .dashboard-topbar .admin-badge {
        /* 관리자 배지 — 파스텔 라벤더 그라디언트 */
        background: linear-gradient(135deg, #c9a6f0 0%, #b48de8 100%);
        color: #fff;
        font-size: 0.72rem;
        font-weight: 700;
        padding: 4px 14px;
        border-radius: 999px;
        letter-spacing: 0.04em;
        box-shadow: 0 2px 8px rgba(180, 141, 232, 0.3);
      }

      /* ===========================
         구분선
         =========================== */
      .divider {
        border: none;
        border-top: 1px solid var(--color-border);
        margin: 20px 0;
      }

      /* ===========================
         뒤로 가기 버튼 영역
         =========================== */
      .back-bar {
        margin-bottom: 16px;
      }

      /* ===========================
         폼 하단 링크 영역
         =========================== */
      .form-footer {
        text-align: center;
        margin-top: 16px;
        font-size: 0.88rem;
        color: var(--color-text-secondary);
      }

      .form-footer .btn--link {
        margin-left: 6px;
      }

      /* ===========================
         반응형 레이아웃 (모바일)
         =========================== */
      @media (max-width: 480px) {
        body {
          padding: 28px 12px 60px;
        }

        .app-header h1 {
          font-size: 1.6rem;
        }

        .role-select-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .role-card {
          display: flex;
          align-items: center;
          gap: 16px;
          padding: 16px 18px;
          text-align: left;
        }

        .role-card-icon {
          font-size: 2rem;
          margin-bottom: 0;
          flex-shrink: 0;
        }

        .card-body {
          padding: 18px;
        }

        .form-row {
          grid-template-columns: 1fr 1fr;
        }

        .user-list-table th,
        .user-list-table td {
          padding: 8px 10px;
        }

        .admin-comment-input-row {
          flex-direction: column;
        }

        .date-filter-row {
          flex-direction: column;
          align-items: stretch;
        }
      }

      /* ===========================
         공지사항 카드 (사용자 홈)
         =========================== */

      /* 공지사항 내용 표시 박스 — 파스텔 노란 계열 */
      .notice-content-box {
        background: linear-gradient(135deg, #fffbee 0%, #fff8e0 100%);
        border: 1.5px solid #f5d88a;
        border-radius: var(--radius-md);
        padding: 16px 18px;
        margin-bottom: 14px;
        line-height: 1.75;
        font-size: 0.97rem;
        color: var(--color-text-primary);
        word-break: break-all;
        white-space: pre-wrap;
      }

      /* 공지사항 없음 안내 */
      .notice-empty {
        text-align: center;
        padding: 24px 16px;
        color: var(--color-text-muted);
        font-size: 0.88rem;
        line-height: 1.8;
      }

      .notice-empty-icon {
        font-size: 1.8rem;
        display: block;
        margin-bottom: 8px;
      }

      /* 확인 완료 상태 뱃지 — 파스텔 민트 */
      .notice-read-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #edfaf5 0%, #d6f5ea 100%);
        color: #2e8a6e;
        font-size: 0.85rem;
        font-weight: 700;
        padding: 8px 18px;
        border-radius: 999px;
        border: 1.5px solid #a8e8d4;
        width: 100%;
        justify-content: center;
      }

      /* 확인 버튼 비활성화 상태 */
      .btn--confirm-done {
        background: #edfaf5;
        color: #2e8a6e;
        border: 1.5px solid #a8e8d4;
        cursor: default;
        opacity: 1;
      }

      .btn--confirm-done:hover {
        transform: none;
        box-shadow: none;
      }

      /* ===========================
         관리자 공지사항 작성 카드
         =========================== */

      /* 공지사항 입력 영역 */
      .notice-write-wrap {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* 글자 수 카운터 (공지사항용) */
      .notice-char-count {
        font-size: 0.78rem;
        color: var(--color-text-muted);
        text-align: right;
        margin-top: -6px;
      }

      .notice-char-count.near-limit {
        color: var(--color-warning);
      }

      .notice-char-count.at-limit {
        color: var(--color-danger);
      }

      /* ===========================
         공지사항 열람자 테이블
         =========================== */

      /* 열람 현황 요약 행 */
      .reader-summary {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 14px;
        font-size: 0.88rem;
        color: var(--color-text-secondary);
      }

      .reader-count-badge {
        /* 파스텔 라벤더 배지 */
        background: linear-gradient(135deg, #c9a6f0 0%, #b48de8 100%);
        color: #fff;
        font-size: 0.75rem;
        font-weight: 700;
        padding: 3px 12px;
        border-radius: 999px;
        letter-spacing: 0.02em;
        box-shadow: 0 2px 8px rgba(180, 141, 232, 0.3);
      }

      /* 열람자 테이블 */
      .reader-list-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.88rem;
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--color-border);
      }

      .reader-list-table thead tr {
        background: linear-gradient(135deg, #f5eeff 0%, #fce8f8 100%);
      }

      .reader-list-table th {
        padding: 10px 14px;
        font-weight: 700;
        color: var(--color-primary);
        text-align: left;
        border-bottom: 2px solid #dcc8f5;
        white-space: nowrap;
      }

      .reader-list-table td {
        padding: 10px 14px;
        color: var(--color-text-primary);
        border-bottom: 1px solid var(--color-border);
      }

      .reader-list-table tbody tr:last-child td {
        border-bottom: none;
      }

      .reader-list-table tbody tr:hover {
        background: #f9f2ff;
      }

      /* 읽은 시각 셀 — 보조 색상 */
      .reader-time-cell {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }

      /* 열람자 없음 안내 */
      .reader-list-empty {
        text-align: center;
        padding: 24px 16px;
        color: var(--color-text-muted);
        font-size: 0.88rem;
        line-height: 1.8;
      }

      /* ===========================
         입력창 흔들림 애니메이션
         =========================== */
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%       { transform: translateX(-6px); }
        40%       { transform: translateX(6px); }
        60%       { transform: translateX(-4px); }
        80%       { transform: translateX(4px); }
      }

      .input-error-shake {
        animation: shake 0.35s ease;
        /* 파스텔 레드 에러 테두리 */
        border-color: #f08080 !important;
      }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div class="app-container" id="appContainer">

      <!-- 앱 공통 헤더 -->
      <header class="app-header">
        <span class="header-icon">🌸</span>
        <h1>우리 반 홈페이지 ✨</h1>
        <p>회원가입 후 이름과 비밀번호로 로그인하세요.</p>
      </header>

      <!-- ==============================
           화면 1: 메인 (역할 선택)
           ============================== -->
      <div class="screen active" id="screenMain">
        <div class="role-select-grid">
          <!-- 관리자 로그인 -->
          <div class="role-card" id="btnGoAdminLogin" role="button" tabindex="0" aria-label="관리자 로그인으로 이동">
            <span class="role-card-icon">🎀</span>
            <div class="role-card-title">관리자 로그인</div>
            <div class="role-card-desc">관리자 전용<br/>대시보드 접속</div>
          </div>
          <!-- 사용자 로그인 -->
          <div class="role-card" id="btnGoUserLogin" role="button" tabindex="0" aria-label="사용자 로그인으로 이동">
            <span class="role-card-icon">🐰</span>
            <div class="role-card-title">사용자 로그인</div>
            <div class="role-card-desc">이름 + 비밀번호로<br/>로그인</div>
          </div>
          <!-- 회원가입 -->
          <div class="role-card" id="btnGoRegister" role="button" tabindex="0" aria-label="회원가입으로 이동">
            <span class="role-card-icon">🌟</span>
            <div class="role-card-title">회원가입</div>
            <div class="role-card-desc">정보를 입력하여<br/>회원 등록</div>
          </div>
        </div>
      </div>

      <!-- ==============================
           화면 2: 회원가입
           ============================== -->
      <div class="screen" id="screenRegister">
        <div class="back-bar">
          <button class="btn btn--ghost" id="btnBackFromRegister" type="button">
            🌸 처음으로
          </button>
        </div>
        <div class="card">
          <div class="card-header">
            <h2>🌟 회원가입</h2>
            <p>학년, 반, 이름과 비밀번호를 입력하여 회원으로 등록하세요.</p>
          </div>
          <div class="card-body">
            <!-- 가입 결과 메시지 (기본 숨김) -->
            <div class="alert" id="registerAlert" style="display: none;" role="alert" aria-live="polite">
              <span class="alert-icon" id="registerAlertIcon"></span>
              <span id="registerAlertMsg"></span>
            </div>

            <!-- 학년 + 반 드롭다운 (나란히) -->
            <div class="form-row">
              <div class="form-group">
                <label class="form-label" for="registerGrade">학년</label>
                <select id="registerGrade" class="form-select" aria-label="학년 선택">
                  <option value="">선택</option>
                  <option value="1">1학년</option>
                  <option value="2">2학년</option>
                  <option value="3">3학년</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="registerClass">반</label>
                <select id="registerClass" class="form-select" aria-label="반 선택">
                  <option value="">선택</option>
                  <option value="1">1반</option>
                  <option value="2">2반</option>
                  <option value="3">3반</option>
                  <option value="4">4반</option>
                  <option value="5">5반</option>
                  <option value="6">6반</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="registerName">이름</label>
              <input
                type="text"
                id="registerName"
                class="form-input"
                placeholder="이름을 입력하세요"
                maxlength="20"
                autocomplete="name"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="registerPassword">비밀번호</label>
              <input
                type="password"
                id="registerPassword"
                class="form-input"
                placeholder="사용할 비밀번호를 입력하세요"
                maxlength="50"
                autocomplete="new-password"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="registerPasswordConfirm">비밀번호 확인</label>
              <input
                type="password"
                id="registerPasswordConfirm"
                class="form-input"
                placeholder="비밀번호를 다시 입력하세요"
                maxlength="50"
                autocomplete="new-password"
              />
            </div>

            <button class="btn btn--primary btn--full" id="btnRegisterSubmit" type="button">
              회원가입
            </button>

            <div class="form-footer">
              이미 계정이 있으신가요?
              <button class="btn--link" id="btnGoUserLoginFromRegister" type="button">로그인하기</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==============================
           화면 3: 사용자 로그인
           ============================== -->
      <div class="screen" id="screenUserLogin">
        <div class="back-bar">
          <button class="btn btn--ghost" id="btnBackFromUserLogin" type="button">
            🌸 처음으로
          </button>
        </div>
        <div class="card">
          <div class="card-header">
            <h2>🐰 사용자 로그인</h2>
            <p>등록된 이름과 비밀번호를 입력하여 로그인하세요.</p>
          </div>
          <div class="card-body">
            <!-- 로그인 에러 메시지 (기본 숨김) -->
            <div class="alert alert--error" id="userLoginAlert" style="display: none;" role="alert" aria-live="polite">
              <span class="alert-icon">⚠️</span>
              <span id="userLoginAlertMsg"></span>
            </div>

            <div class="form-group">
              <label class="form-label" for="userLoginName">이름</label>
              <input
                type="text"
                id="userLoginName"
                class="form-input"
                placeholder="이름을 입력하세요"
                maxlength="20"
                autocomplete="name"
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="userLoginPassword">비밀번호</label>
              <input
                type="password"
                id="userLoginPassword"
                class="form-input"
                placeholder="비밀번호를 입력하세요"
                maxlength="50"
                autocomplete="current-password"
              />
            </div>

            <button class="btn btn--primary btn--full" id="btnUserLoginSubmit" type="button">
              로그인
            </button>

            <div class="form-footer">
              계정이 없으신가요?
              <button class="btn--link" id="btnGoRegisterFromLogin" type="button">회원가입하기</button>
            </div>
            <p style="text-align:center; font-size:0.75rem; color:var(--color-text-muted); margin-top:10px;">비밀번호 분실 시 선생님께 문의하세요</p>
          </div>
        </div>
      </div>

      <!-- ==============================
           화면 4: 사용자 홈
           ============================== -->
      <div class="screen" id="screenUserHome">
        <!-- 통합 상단 네비게이션 바 -->
        <nav class="user-navbar">
          <!-- 왼쪽: 탭 메뉴 -->
          <div class="user-navbar-tabs" role="tablist">
            <button class="nav-home" id="btnNavHome" type="button">🏠 우리반</button>
            <button role="tab" id="tabNotice" class="active" aria-selected="true" aria-controls="tabContentNotice">📢 공지사항</button>
            <button role="tab" id="tabReview" aria-selected="false" aria-controls="tabContentReview">📅 일정</button>
          </div>
          <!-- 오른쪽: 비밀번호변경 + 이름 + 로그아웃 아이콘 -->
          <div class="user-navbar-user">
            <button class="btn-change-pw" id="btnChangePw" type="button">🔒 비밀번호 변경</button>
            <span class="navbar-username" id="navbarUserName">홍길동</span>
            <button class="btn--logout-icon" id="btnUserLogout" type="button" title="로그아웃" aria-label="로그아웃">
              <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </button>
          </div>
        </nav>

        <!-- 탭 콘텐츠: 공지사항 -->
        <div class="user-tab-content active" id="tabContentNotice" role="tabpanel" aria-labelledby="tabNotice">
          <div class="diary-layout">
            <!-- 상단: 월/연도 헤더 -->
            <div class="diary-header">
              <div class="header-left">
                <button class="diary-nav-btn" id="btnNoticeMonthPrev" type="button" title="이전 달">◀</button>
                <span class="month-num" id="noticeMonthNum"></span>
                <div class="month-detail">
                  <span class="month-eng" id="noticeMonthEng"></span>
                  <span class="month-year" id="noticeMonthYear"></span>
                </div>
                <button class="diary-nav-btn" id="btnNoticeMonthNext" type="button" title="다음 달">▶</button>
              </div>
              <button class="btn-today" id="btnNoticeToday" type="button">오늘</button>
            </div>

            <!-- 가로 날짜 스트립 -->
            <div class="diary-date-strip-wrap">
              <div class="diary-date-strip" id="noticeDateStrip"></div>
            </div>

            <!-- 선택된 날짜 정보 -->
            <div class="diary-date-info" id="noticeDateInfo">
              <span class="info-day-num" id="noticeInfoDay"></span>
              <div class="info-right">
                <span class="info-dow" id="noticeInfoDow"></span>
                <span class="info-lunar" id="noticeInfoLunar"></span>
              </div>
            </div>

            <!-- 공지사항 내용 (JS에서 동적으로 채움) -->
            <div style="padding: 0 22px 20px;">
              <div id="userNoticeCardBody"></div>
            </div>
          </div>
        </div>

        <!-- 탭 콘텐츠: 시간대별 한줄평 (다이어리 스타일) -->
        <div class="user-tab-content" id="tabContentReview" role="tabpanel" aria-labelledby="tabReview">
          <div class="diary-layout">
            <!-- 상단: 월/연도 헤더 + 네비게이션 -->
            <div class="diary-header">
              <div class="header-left">
                <button class="diary-nav-btn" id="btnDiaryPrev" type="button" title="이전 달">◀</button>
                <span class="month-num" id="diaryMonthNum"></span>
                <div class="month-detail">
                  <span class="month-eng" id="diaryMonthEng"></span>
                  <span class="month-year" id="diaryMonthYear"></span>
                </div>
                <button class="diary-nav-btn" id="btnDiaryNext" type="button" title="다음 달">▶</button>
              </div>
              <button class="btn-today" id="btnDiaryToday" type="button">오늘</button>
            </div>

            <!-- 가로 날짜 스트립 (JS에서 동적 생성) -->
            <div class="diary-date-strip-wrap">
              <div class="diary-date-strip" id="diaryDateStrip"></div>
            </div>

            <!-- 선택된 날짜 정보 영역 (JS에서 동적 갱신) -->
            <div class="diary-date-info" id="diaryDateInfo">
              <span class="info-day-num" id="diaryInfoDay"></span>
              <div class="info-right">
                <span class="info-dow" id="diaryInfoDow"></span>
                <span class="info-lunar" id="diaryInfoLunar"></span>
              </div>
            </div>

            <!-- 알림 메시지 -->
            <div class="diary-alert-wrap">
              <div class="alert" id="reviewWriteAlert" style="display: none;" role="alert" aria-live="polite">
                <span class="alert-icon" id="reviewWriteAlertIcon"></span>
                <span id="reviewWriteAlertMsg"></span>
              </div>
            </div>

            <!-- 시간대별 줄노트 (JS에서 동적 생성) -->
            <div class="diary-hour-rows" id="diaryHourRows"></div>

            <!-- 하단 한줄평 작성 영역 -->
            <div class="diary-review-section" id="diaryReviewSection"></div>
          </div>
        </div>
      </div>

      <!-- ==============================
           화면 5: 관리자 로그인
           ============================== -->
      <div class="screen" id="screenAdminLogin">
        <div class="back-bar">
          <button class="btn btn--ghost" id="btnBackFromAdminLogin" type="button">
            🌸 처음으로
          </button>
        </div>
        <div class="card">
          <div class="card-header">
            <h2>🎀 관리자 로그인</h2>
            <p>관리자 비밀번호를 입력하여 대시보드에 접속하세요.</p>
          </div>
          <div class="card-body">
            <!-- 로그인 에러 메시지 (기본 숨김) -->
            <div class="alert alert--error" id="adminLoginError" style="display: none;" role="alert" aria-live="polite">
              <span class="alert-icon">⚠️</span>
              <span id="adminLoginErrorMsg">비밀번호가 올바르지 않습니다.</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="adminPasswordInput">비밀번호</label>
              <input
                type="password"
                id="adminPasswordInput"
                class="form-input"
                placeholder="비밀번호를 입력하세요"
                autocomplete="current-password"
                maxlength="50"
              />
            </div>

            <button class="btn btn--primary btn--full" id="btnAdminLogin" type="button">
              로그인
            </button>

            <div style="text-align:center; margin-top:12px;">
              <button class="btn btn--ghost" id="btnAdminForgotPw" type="button" style="font-size:0.8rem; color:var(--color-text-secondary);">
                비밀번호를 잊으셨나요?
              </button>
            </div>

            <!-- 비밀번호 초기화 폼 (기본 숨김) -->
            <div id="adminResetPwForm" style="display:none; margin-top:16px; padding-top:16px; border-top:1.5px solid var(--color-border);">
              <p style="font-size:0.82rem; font-weight:700; color:var(--color-primary); margin-bottom:12px;">관리자 정보를 입력하여 본인 확인</p>
              <div class="alert alert--error" id="adminResetAlert" style="display:none;" role="alert">
                <span class="alert-icon">⚠️</span>
                <span id="adminResetAlertMsg"></span>
              </div>
              <div class="form-group">
                <label class="form-label">이름</label>
                <input type="text" class="form-input" id="resetAdminName" placeholder="관리자 이름" />
              </div>
              <div class="form-group">
                <label class="form-label">생년월일</label>
                <input type="date" class="form-input" id="resetAdminBirth" />
              </div>
              <div class="form-group">
                <label class="form-label">전화번호</label>
                <input type="tel" class="form-input" id="resetAdminPhone" placeholder="010-0000-0000" />
              </div>
              <button class="btn btn--primary btn--full" id="btnAdminResetPw" type="button">
                비밀번호 초기화
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ==============================
           화면 6: 관리자 대시보드
           ============================== -->
      <div class="screen" id="screenAdminDashboard">
        <!-- 관리자 통합 상단 네비게이션 바 -->
        <nav class="user-navbar">
          <div class="user-navbar-tabs" role="tablist">
            <button class="nav-home" id="btnAdminNavHome" type="button">🏠 우리반</button>
            <button role="tab" id="adminTabUsers" class="active" aria-selected="true" aria-controls="adminTabContentUsers">🐥 사용자</button>
            <button role="tab" id="adminTabNotice" aria-selected="false" aria-controls="adminTabContentNotice">📢 공지</button>
            <button role="tab" id="adminTabReview" aria-selected="false" aria-controls="adminTabContentReview">📝 한줄평</button>
          </div>
          <div class="user-navbar-user">
            <span class="navbar-username">관리자</span>
            <div class="navbar-dropdown-wrap">
              <button class="btn-dropdown-arrow" id="btnAdminDropdown" type="button" title="메뉴">▼</button>
              <div class="navbar-dropdown" id="adminDropdownMenu">
                <button class="dropdown-item" id="btnAdminDropdownProfile" type="button">👤 관리자 정보</button>
                <button class="dropdown-item" id="btnAdminDropdownChangePw" type="button">🔒 비밀번호 변경</button>
              </div>
            </div>
            <button class="btn--logout-icon" id="btnAdminLogout" type="button" title="로그아웃" aria-label="로그아웃">
              <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            </button>
          </div>
        </nav>

        <!-- 관리자 정보 패널 (기본 숨김) -->
        <div class="profile-panel" id="adminProfilePanel" style="display:none;">
          <div class="profile-panel-header">
            <h3>👤 관리자 정보</h3>
            <button class="btn-profile-close" id="btnCloseAdminProfile" type="button">✕</button>
          </div>
          <div class="profile-panel-body">
            <div class="form-group">
              <label class="form-label">이름</label>
              <input type="text" class="form-input" id="adminProfileName" placeholder="이름" />
            </div>
            <div class="form-group">
              <label class="form-label">생년월일</label>
              <input type="date" class="form-input" id="adminProfileBirth" />
            </div>
            <div class="form-group">
              <label class="form-label">전화번호</label>
              <input type="tel" class="form-input" id="adminProfilePhone" placeholder="010-0000-0000" />
            </div>
            <button class="btn btn--primary btn--full" id="btnSaveAdminProfile" type="button">저장</button>
          </div>
        </div>

        <!-- 탭 콘텐츠: 사용자 목록 -->
        <div class="user-tab-content active" id="adminTabContentUsers" role="tabpanel" aria-labelledby="adminTabUsers">
          <div class="card">
            <div class="card-header">
              <h2>🐥 가입 사용자 목록</h2>
              <p>현재 시스템에 등록된 모든 사용자 목록입니다. 학년 · 반 순으로 정렬됩니다.</p>
            </div>
            <div class="card-body" style="padding: 20px 24px;">
              <div class="section-title">
                <span>등록 사용자</span>
                <span class="user-count-badge" id="userCountBadge">0명</span>
              </div>
              <div id="userListContainer"></div>
            </div>
          </div>
        </div>

        <!-- 탭 콘텐츠: 공지사항 -->
        <div class="user-tab-content" id="adminTabContentNotice" role="tabpanel" aria-labelledby="adminTabNotice">
          <div class="diary-layout">
            <!-- 상단: 월/연도 헤더 -->
            <div class="diary-header">
              <div class="header-left">
                <button class="diary-nav-btn" id="btnAdminNoticeMonthPrev" type="button" title="이전 달">◀</button>
                <span class="month-num" id="adminNoticeMonthNum"></span>
                <div class="month-detail">
                  <span class="month-eng" id="adminNoticeMonthEng"></span>
                  <span class="month-year" id="adminNoticeMonthYear"></span>
                </div>
                <button class="diary-nav-btn" id="btnAdminNoticeMonthNext" type="button" title="다음 달">▶</button>
              </div>
              <button class="btn-today" id="btnAdminNoticeToday" type="button">오늘</button>
            </div>

            <!-- 가로 날짜 스트립 -->
            <div class="diary-date-strip-wrap">
              <div class="diary-date-strip" id="adminNoticeDateStrip"></div>
            </div>

            <!-- 선택된 날짜 정보 -->
            <div class="diary-date-info" id="adminNoticeDateInfo">
              <span class="info-day-num" id="adminNoticeInfoDay"></span>
              <div class="info-right">
                <span class="info-dow" id="adminNoticeInfoDow"></span>
                <span class="info-lunar" id="adminNoticeInfoLunar"></span>
              </div>
            </div>

            <div style="padding: 0 22px 20px;">
              <div class="alert" id="noticeWriteAlert" style="display: none;" role="alert" aria-live="polite">
                <span class="alert-icon" id="noticeWriteAlertIcon"></span>
                <span id="noticeWriteAlertMsg"></span>
              </div>
              <div class="notice-write-wrap">
                <div class="form-group" style="margin-bottom: 4px;">
                  <textarea
                    id="noticeContentInput"
                    class="form-textarea"
                    placeholder="공지사항 내용을 입력하세요. (최대 300자)"
                    maxlength="300"
                    rows="4"
                  ></textarea>
                </div>
                <div class="notice-char-count" id="noticeCharCount">0 / 300자</div>
                <button class="btn btn--primary btn--full" id="btnSaveNotice" type="button" style="margin-top: 6px;">
                  공지사항 저장
                </button>
              </div>

              <!-- 공지사항 열람자 확인 -->
              <div style="margin-top: 20px;">
                <h3 style="font-size: 0.95rem; font-weight: 700; color: var(--color-primary); margin-bottom: 10px;">👀 열람자 확인</h3>
                <div id="noticeReaderContainer"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 탭 콘텐츠: 한줄평 관리 -->
        <div class="user-tab-content" id="adminTabContentReview" role="tabpanel" aria-labelledby="adminTabReview">
          <div class="diary-layout">
            <!-- 상단: 월/연도 헤더 -->
            <div class="diary-header">
              <div class="header-left">
                <button class="diary-nav-btn" id="btnAdminReviewMonthPrev" type="button" title="이전 달">◀</button>
                <span class="month-num" id="adminReviewMonthNum"></span>
                <div class="month-detail">
                  <span class="month-eng" id="adminReviewMonthEng"></span>
                  <span class="month-year" id="adminReviewMonthYear"></span>
                </div>
                <button class="diary-nav-btn" id="btnAdminReviewMonthNext" type="button" title="다음 달">▶</button>
              </div>
              <button class="btn-today" id="btnAdminReviewToday" type="button">오늘</button>
            </div>

            <!-- 가로 날짜 스트립 -->
            <div class="diary-date-strip-wrap">
              <div class="diary-date-strip" id="adminReviewDateStrip"></div>
            </div>

            <!-- 선택된 날짜 정보 -->
            <div class="diary-date-info" id="adminReviewDateInfo">
              <span class="info-day-num" id="adminReviewInfoDay"></span>
              <div class="info-right">
                <span class="info-dow" id="adminReviewInfoDow"></span>
                <span class="info-lunar" id="adminReviewInfoLunar"></span>
              </div>
            </div>

            <!-- 숨겨진 날짜 필터 (기존 로직 호환용) -->
            <input type="hidden" id="adminReviewDateFilter" />

            <div style="padding: 0 22px 20px;">
              <div class="section-title">
                <span id="adminReviewDateLabel">선택된 날짜의 한줄평</span>
                <span class="review-count-badge" id="adminReviewCountBadge">0건</span>
              </div>
              <div id="adminReviewListContainer"></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /.app-container -->

    <script>
      // =========================================
      // Firebase 초기화
      // =========================================

      const firebaseConfig = {
        apiKey: "AIzaSyBAf42FRejA27Inv76z1qQOL9rHdr7-QcE",
        authDomain: "yumi-student.firebaseapp.com",
        databaseURL: "https://yumi-student-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "yumi-student",
        storageBucket: "yumi-student.firebasestorage.app",
        messagingSenderId: "248222829485",
        appId: "1:248222829485:web:b7f0bbaed4163c57fbaf24"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // =========================================
      // 메모리 캐시 (Firebase 동기화용)
      // =========================================

      let _usersCache = [];
      let _noticesCache = [];
      let _reviewsCache = [];
      let _firebaseReady = false;
      /** 현재 활성화된 화면 ID (실시간 갱신용) */
      let _currentScreen = null;

      // =========================================
      // 상수 및 설정
      // =========================================

      /**
       * 관리자 비밀번호 (클라이언트 사이드 검증이므로 보안 한계 있음.
       * 실제 서비스에서는 서버 측 인증으로 대체해야 합니다.)
       */
      let ADMIN_PASSWORD = 'admin1234';

      /** localStorage 키 (하위 호환용) */
      const USERS_STORAGE_KEY = 'auth-system-users';

      /** localStorage 키 (하위 호환용) */
      const REVIEWS_STORAGE_KEY = 'auth-system-reviews';

      /** localStorage 키 (하위 호환용) */
      const NOTICES_STORAGE_KEY = 'auth-system-notices';

      /** 공지사항 최대 글자 수 */
      const NOTICE_MAX_LENGTH = 300;

      /** 한줄평 최대 글자 수 */
      const REVIEW_MAX_LENGTH = 100;

      /**
       * 화면 ID 목록 — 상태 머신(State Machine)으로 화면 전환을 관리합니다.
       * 각 값은 실제 DOM 요소의 id 속성과 일치해야 합니다.
       */
      const SCREENS = {
        MAIN: 'screenMain',
        REGISTER: 'screenRegister',
        USER_LOGIN: 'screenUserLogin',
        USER_HOME: 'screenUserHome',
        ADMIN_LOGIN: 'screenAdminLogin',
        ADMIN_DASHBOARD: 'screenAdminDashboard',
      };

      /** 현재 로그인된 사용자 (세션 메모리) */
      let currentUser = null;

      // =========================================
      // 날짜 유틸리티
      // =========================================

      /**
       * 오늘 날짜를 'YYYY-MM-DD' 형식으로 반환합니다.
       * @returns {string}
       */
      function getTodayKey() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      /**
       * 'YYYY-MM-DD' 형식의 날짜 문자열을 한국어 형식으로 변환합니다.
       * @param {string} dateKey
       * @returns {string} 예: "2026년 2월 21일"
       */
      function formatDateKorean(dateKey) {
        const [y, m, d] = dateKey.split('-');
        return `${y}년 ${Number(m)}월 ${Number(d)}일`;
      }

      // =========================================
      // 사용자 스토리지 레이어
      // =========================================

      /**
       * localStorage에서 가입 사용자 배열을 불러옵니다.
       * @returns {Array<{ id: string, grade: string, classNum: string, name: string, password: string }>}
       */
      function loadUsersFromStorage() {
        return _usersCache;
      }

      /**
       * 사용자 배열을 캐시 + Firebase에 저장합니다.
       * @param {Array} users
       */
      function saveUsersToStorage(users) {
        _usersCache = users;
        db.ref('users').set(users).catch(err => {
          console.warn('사용자 데이터 Firebase 저장 실패:', err);
        });
      }

      /**
       * 새 사용자를 등록합니다.
       * 동일한 이름이 이미 존재하면 실패를 반환합니다.
       *
       * @param {{ grade: string, classNum: string, name: string, password: string }} userData
       * @returns {{ success: boolean, reason?: string }}
       */
      function registerUser(userData) {
        const users = loadUsersFromStorage();

        const newUser = {
          id: Date.now().toString(),
          grade: userData.grade,
          classNum: userData.classNum,
          name: userData.name.trim(),
          password: userData.password,
        };

        users.push(newUser);
        saveUsersToStorage(users);
        return { success: true };
      }

      /**
       * 이름과 비밀번호로 사용자를 찾아 반환합니다.
       *
       * @param {string} name
       * @param {string} password
       * @returns {{ success: boolean, user?: object }}
       */
      function authenticateUser(name, password) {
        const users = loadUsersFromStorage();
        const matched = users.find(
          (u) => u.name.trim() === name.trim() && u.password === password
        );
        if (matched) return { success: true, user: matched };
        return { success: false };
      }

      /**
       * 가입 사용자 목록을 학년 → 반 오름차순으로 정렬하여 반환합니다.
       * @returns {Array}
       */
      function getSortedUsers() {
        const users = loadUsersFromStorage();
        return users.slice().sort((a, b) => {
          const gradeDiff = Number(a.grade) - Number(b.grade);
          if (gradeDiff !== 0) return gradeDiff;
          return Number(a.classNum) - Number(b.classNum);
        });
      }

      // =========================================
      // 공지사항 스토리지 레이어
      // =========================================

      /**
       * localStorage에서 공지사항 배열 전체를 불러옵니다.
       * @returns {Array<{
       *   id: string,
       *   dateKey: string,
       *   content: string,
       *   createdAt: string,
       *   readers: Array<{ userId: string, userName: string, userGrade: string, userClass: string, readAt: string }>
       * }>}
       */
      function loadNoticesFromStorage() {
        return _noticesCache;
      }

      /**
       * 공지사항 배열을 캐시 + Firebase에 저장합니다.
       * @param {Array} notices
       */
      function saveNoticesToStorage(notices) {
        _noticesCache = notices;
        db.ref('notices').set(notices).catch(err => {
          console.warn('공지사항 데이터 Firebase 저장 실패:', err);
        });
      }

      /**
       * 특정 날짜의 공지사항을 찾아 반환합니다.
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @returns {object|null}
       */
      function findNoticeByDate(dateKey) {
        const notices = loadNoticesFromStorage();
        return notices.find((n) => n.dateKey === dateKey) || null;
      }

      /**
       * 공지사항을 저장하거나 수정합니다.
       * 같은 날짜의 공지사항이 이미 있으면 내용을 수정하고,
       * 없으면 새로 추가합니다. 기존 열람자 목록은 보존합니다.
       *
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @param {string} content
       * @returns {{ success: boolean, isUpdate: boolean }}
       */
      function upsertNotice(dateKey, content) {
        const notices = loadNoticesFromStorage();
        const existingIndex = notices.findIndex((n) => n.dateKey === dateKey);

        if (existingIndex !== -1) {
          // 기존 공지사항 수정 (열람자 목록은 그대로 유지)
          notices[existingIndex] = {
            ...notices[existingIndex],
            content: content.trim(),
            updatedAt: new Date().toISOString(),
          };
          saveNoticesToStorage(notices);
          return { success: true, isUpdate: true };
        }

        // 새 공지사항 추가
        const newNotice = {
          id: Date.now().toString(),
          dateKey: dateKey,
          content: content.trim(),
          createdAt: new Date().toISOString(),
          readers: [],
        };
        notices.push(newNotice);
        saveNoticesToStorage(notices);
        return { success: true, isUpdate: false };
      }

      /**
       * 특정 사용자가 특정 날짜의 공지사항을 이미 읽었는지 확인합니다.
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @param {string} userId
       * @returns {boolean}
       */
      function hasReadNotice(dateKey, userId) {
        const notice = findNoticeByDate(dateKey);
        if (!notice) return false;
        return notice.readers.some((r) => r.userId === userId);
      }

      /**
       * 사용자가 공지사항을 읽었음을 기록합니다.
       * 이미 읽은 경우에는 중복 기록하지 않습니다.
       *
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @param {{ id: string, name: string, grade: string, classNum: string }} user
       * @returns {boolean} 성공 여부
       */
      function markNoticeAsRead(dateKey, user) {
        const notices = loadNoticesFromStorage();
        const idx = notices.findIndex((n) => n.dateKey === dateKey);
        if (idx === -1) return false;

        // 중복 확인: 이미 읽은 경우 무시
        const alreadyRead = notices[idx].readers.some((r) => r.userId === user.id);
        if (alreadyRead) return true;

        notices[idx].readers.push({
          userId:    user.id,
          userName:  user.name,
          userGrade: user.grade,
          userClass: user.classNum,
          readAt:    new Date().toISOString(),
        });
        saveNoticesToStorage(notices);
        return true;
      }

      // =========================================
      // 한줄평 스토리지 레이어
      // =========================================

      /**
       * localStorage에서 한줄평 배열 전체를 불러옵니다.
       * @returns {Array<{
       *   id: string,
       *   userId: string,
       *   userName: string,
       *   userGrade: string,
       *   userClass: string,
       *   dateKey: string,
       *   content: string,
       *   adminComment: string,
       *   createdAt: string
       * }>}
       */
      function loadReviewsFromStorage() {
        return _reviewsCache;
      }

      /**
       * 한줄평 배열을 캐시 + Firebase에 저장합니다.
       * @param {Array} reviews
       */
      function saveReviewsToStorage(reviews) {
        _reviewsCache = reviews;
        db.ref('reviews').set(reviews).catch(err => {
          console.warn('한줄평 데이터 Firebase 저장 실패:', err);
        });
      }

      /**
       * 특정 사용자의 특정 날짜 한줄평을 찾아 반환합니다.
       * @param {string} userId
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @returns {object|null}
       */
      function findReview(userId, dateKey) {
        const reviews = loadReviewsFromStorage();
        return reviews.find((r) => r.userId === userId && r.dateKey === dateKey) || null;
      }

      /**
       * 한줄평을 저장하거나 수정합니다.
       * - 같은 사용자의 같은 날짜 한줄평이 이미 있으면 내용을 수정합니다.
       * - 없으면 새로 추가합니다.
       *
       * @param {{ userId: string, userName: string, userGrade: string, userClass: string, dateKey: string, content: string }} reviewData
       * @returns {{ success: boolean, isUpdate: boolean }}
       */
      function upsertReview(reviewData) {
        const reviews = loadReviewsFromStorage();
        const existingIndex = reviews.findIndex(
          (r) => r.userId === reviewData.userId && r.dateKey === reviewData.dateKey
        );

        if (existingIndex !== -1) {
          // 기존 한줄평 수정 (관리자 평가 코멘트는 그대로 유지)
          reviews[existingIndex] = {
            ...reviews[existingIndex],
            content: reviewData.content,
            updatedAt: new Date().toISOString(),
          };
          saveReviewsToStorage(reviews);
          return { success: true, isUpdate: true };
        }

        // 새 한줄평 추가
        const newReview = {
          id: Date.now().toString(),
          userId: reviewData.userId,
          userName: reviewData.userName,
          userGrade: reviewData.userGrade,
          userClass: reviewData.userClass,
          dateKey: reviewData.dateKey,
          content: reviewData.content,
          adminComment: '',
          createdAt: new Date().toISOString(),
        };
        reviews.push(newReview);
        saveReviewsToStorage(reviews);
        return { success: true, isUpdate: false };
      }

      /**
       * 관리자 평가 코멘트를 특정 한줄평(id)에 저장합니다.
       * @param {string} reviewId
       * @param {string} comment
       * @returns {boolean} 성공 여부
       */
      function saveAdminComment(reviewId, comment) {
        const reviews = loadReviewsFromStorage();
        const idx = reviews.findIndex((r) => r.id === reviewId);
        if (idx === -1) return false;

        reviews[idx].adminComment = comment.trim();
        reviews[idx].commentedAt = new Date().toISOString();
        saveReviewsToStorage(reviews);
        return true;
      }

      /**
       * 특정 사용자의 한줄평을 최근순으로 반환합니다.
       * @param {string} userId
       * @returns {Array}
       */
      function getReviewsByUser(userId) {
        const reviews = loadReviewsFromStorage();
        return reviews
          .filter((r) => r.userId === userId)
          .sort((a, b) => b.dateKey.localeCompare(a.dateKey));
      }

      /**
       * 특정 날짜의 모든 한줄평을 학년 → 반 → 이름 → 시간 순으로 반환합니다.
       * dateKey가 'YYYY-MM-DD' 형식이면 해당 날짜로 시작하는 모든 한줄평을 포함합니다.
       * (시간대별 저장 형식 'YYYY-MM-DD-HH'도 지원)
       * @param {string} dateKey - 'YYYY-MM-DD'
       * @returns {Array}
       */
      function getReviewsByDate(dateKey) {
        const reviews = loadReviewsFromStorage();
        return reviews
          .filter((r) => r.dateKey === dateKey || r.dateKey.startsWith(dateKey + '-'))
          .sort((a, b) => {
            const gradeDiff = Number(a.userGrade) - Number(b.userGrade);
            if (gradeDiff !== 0) return gradeDiff;
            const classDiff = Number(a.userClass) - Number(b.userClass);
            if (classDiff !== 0) return classDiff;
            const nameDiff = a.userName.localeCompare(b.userName);
            if (nameDiff !== 0) return nameDiff;
            // 같은 사용자 내에서 시간대 오름차순
            return a.dateKey.localeCompare(b.dateKey);
          });
      }

      // =========================================
      // 화면 전환 (상태 머신)
      // =========================================

      /**
       * 지정한 화면으로 전환합니다.
       * 관리자 대시보드 화면에서는 컨테이너 너비를 넓힙니다.
       * @param {string} screenId - SCREENS 상수 중 하나의 값
       */
      function navigateTo(screenId) {
        _currentScreen = screenId;
        Object.values(SCREENS).forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('active');
        });
        const targetEl = document.getElementById(screenId);
        if (targetEl) targetEl.classList.add('active');

        // 로그인 후 화면(사용자 홈, 관리자 대시보드)에서 컨테이너 넓게
        const container = document.getElementById('appContainer');
        if (screenId === SCREENS.USER_HOME || screenId === SCREENS.ADMIN_DASHBOARD) {
          container.classList.add('wide');
        } else {
          container.classList.remove('wide');
        }

        // 로그인 상태(사용자 홈, 관리자 대시보드)에서는 앱 헤더 숨김
        const appHeader = document.querySelector('.app-header');
        if (screenId === SCREENS.USER_HOME || screenId === SCREENS.ADMIN_DASHBOARD) {
          appHeader.style.display = 'none';
        } else {
          appHeader.style.display = '';
        }
      }

      // =========================================
      // 공통 유틸: 입력 에러 흔들기 / 알림 표시
      // =========================================

      /**
       * 지정된 input/select 요소에 흔들림 애니메이션을 적용합니다.
       * @param {HTMLElement} el
       */
      function shakeElement(el) {
        el.classList.add('input-error-shake');
        setTimeout(() => el.classList.remove('input-error-shake'), 400);
      }

      /**
       * 알림 박스를 표시합니다.
       * @param {string} alertElId - alert 래퍼 요소 id
       * @param {string} iconElId  - 아이콘 span id
       * @param {string} msgElId   - 메시지 span id
       * @param {'success'|'error'|'warning'|'info'} type
       * @param {string} icon
       * @param {string} message
       */
      function showAlert(alertElId, iconElId, msgElId, type, icon, message) {
        const alertEl = document.getElementById(alertElId);
        const iconEl  = document.getElementById(iconElId);
        const msgEl   = document.getElementById(msgElId);
        alertEl.className = `alert alert--${type}`;
        iconEl.textContent  = icon;
        msgEl.textContent   = message;
        alertEl.style.display = 'flex';
        // 3초 후 자동 숨김
        clearTimeout(alertEl._hideTimer);
        alertEl._hideTimer = setTimeout(() => {
          alertEl.style.display = 'none';
        }, 3000);
      }

      /**
       * 알림 박스를 숨깁니다.
       * @param {string} alertElId
       */
      function hideAlert(alertElId) {
        const alertEl = document.getElementById(alertElId);
        if (alertEl) alertEl.style.display = 'none';
      }

      // =========================================
      // 회원가입 화면 핸들러
      // =========================================

      /**
       * 회원가입 폼을 초기 상태로 리셋합니다.
       */
      function resetRegisterForm() {
        document.getElementById('registerGrade').value = '';
        document.getElementById('registerClass').value = '';
        document.getElementById('registerName').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerPasswordConfirm').value = '';
        hideAlert('registerAlert');
      }

      /**
       * 회원가입 제출을 처리합니다.
       * 유효성 검사 → 중복 검사 → 저장 순으로 진행합니다.
       */
      function handleRegisterSubmit() {
        const gradeEl    = document.getElementById('registerGrade');
        const classEl    = document.getElementById('registerClass');
        const nameEl     = document.getElementById('registerName');
        const pwEl       = document.getElementById('registerPassword');
        const pwConfEl   = document.getElementById('registerPasswordConfirm');

        const grade    = gradeEl.value;
        const classNum = classEl.value;
        const name     = nameEl.value.trim();
        const password = pwEl.value;
        const pwConf   = pwConfEl.value;

        // --- 유효성 검사 ---
        if (!grade) {
          shakeElement(gradeEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '학년을 선택해주세요.');
          gradeEl.focus();
          return;
        }
        if (!classNum) {
          shakeElement(classEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '반을 선택해주세요.');
          classEl.focus();
          return;
        }
        if (!name) {
          shakeElement(nameEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '이름을 입력해주세요.');
          nameEl.focus();
          return;
        }
        if (!password) {
          shakeElement(pwEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '비밀번호를 입력해주세요.');
          pwEl.focus();
          return;
        }
        if (password.length < 4) {
          shakeElement(pwEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '비밀번호는 4자 이상이어야 합니다.');
          pwEl.focus();
          return;
        }
        if (password !== pwConf) {
          shakeElement(pwConfEl);
          showAlert('registerAlert', 'registerAlertIcon', 'registerAlertMsg', 'error', '⚠️', '비밀번호가 일치하지 않습니다. 다시 확인해주세요.');
          pwConfEl.value = '';
          pwConfEl.focus();
          return;
        }

        // --- 도메인 로직: 등록 ---
        const result = registerUser({ grade, classNum, name, password });

        if (!result.success) {
          return;
        }

        // --- 가입 성공 → 로그인 화면으로 자동 이동 ---
        resetRegisterForm();
        resetUserLoginForm();
        navigateTo(SCREENS.USER_LOGIN);
        // 로그인 화면에 가입 완료 메시지 표시
        const loginAlert = document.getElementById('userLoginAlert');
        loginAlert.className = 'alert alert--success';
        loginAlert.innerHTML = `<span class="alert-icon">✅</span><span id="userLoginAlertMsg">가입이 완료되었습니다! 로그인해주세요.</span>`;
        loginAlert.style.display = 'flex';
        requestAnimationFrame(() => document.getElementById('userLoginName').focus());
      }

      // =========================================
      // 사용자 로그인 화면 핸들러
      // =========================================

      /**
       * 사용자 로그인 폼을 초기 상태로 리셋합니다.
       */
      function resetUserLoginForm() {
        document.getElementById('userLoginName').value = '';
        document.getElementById('userLoginPassword').value = '';
        hideAlert('userLoginAlert');
      }

      /**
       * 사용자 로그인 제출을 처리합니다.
       * 성공 시 사용자 홈 화면으로 이동합니다.
       */
      function handleUserLoginSubmit() {
        const nameEl = document.getElementById('userLoginName');
        const pwEl   = document.getElementById('userLoginPassword');

        const name     = nameEl.value.trim();
        const password = pwEl.value;

        if (!name) {
          shakeElement(nameEl);
          document.getElementById('userLoginAlertMsg').textContent = '이름을 입력해주세요.';
          document.getElementById('userLoginAlert').style.display = 'flex';
          nameEl.focus();
          return;
        }
        if (!password) {
          shakeElement(pwEl);
          document.getElementById('userLoginAlertMsg').textContent = '비밀번호를 입력해주세요.';
          document.getElementById('userLoginAlert').style.display = 'flex';
          pwEl.focus();
          return;
        }

        const { success, user } = authenticateUser(name, password);

        if (!success) {
          shakeElement(nameEl);
          shakeElement(pwEl);
          document.getElementById('userLoginAlertMsg').textContent = '이름 또는 비밀번호가 올바르지 않습니다. 다시 확인해주세요.';
          document.getElementById('userLoginAlert').style.display = 'flex';
          pwEl.value = '';
          pwEl.focus();
          return;
        }

        // 로그인 성공 — 현재 사용자 세션 저장 후 홈 화면으로 이동
        currentUser = user;
        hideAlert('userLoginAlert');
        nameEl.value = '';
        pwEl.value   = '';
        renderUserHome(user);
        navigateTo(SCREENS.USER_HOME);
      }

      // =========================================
      // 사용자 홈 화면 렌더링 및 한줄평 기능
      // =========================================

      /**
       * 사용자 홈 화면 전체를 렌더링합니다.
       * 프로필 정보, 한줄평 작성 영역, 내 한줄평 목록을 모두 갱신합니다.
       * @param {{ id: string, grade: string, classNum: string, name: string }} user
       */
      /** 현재 다이어리에서 보고 있는 연/월/일 */
      let diaryViewYear  = null;
      let diaryViewMonth = null; // 0-indexed
      let diaryViewDay   = null; // 1-indexed, 선택된 날짜

      /** 현재 공지사항에서 보고 있는 연/월/일 */
      let noticeViewYear  = null;
      let noticeViewMonth = null; // 0-indexed
      let noticeViewDay   = null; // 1-indexed

      function renderUserHome(user) {
        // 상단 바 사용자 이름 표시
        document.getElementById('navbarUserName').textContent = user.name;

        // 공지사항 날짜를 오늘로 초기화
        const nowN = new Date();
        noticeViewYear  = nowN.getFullYear();
        noticeViewMonth = nowN.getMonth();
        noticeViewDay   = nowN.getDate();
        renderUserNoticeCard(user);

        // 다이어리 한줄평 렌더링 (오늘로 초기화)
        const now = new Date();
        diaryViewYear  = now.getFullYear();
        diaryViewMonth = now.getMonth();
        diaryViewDay   = now.getDate();
        renderDiaryView(user);

        // 탭을 공지사항(기본)으로 초기화
        switchUserTab('notice');
      }

      /**
       * 다이어리 월 이동
       */
      function navigateDiaryMonth(user, delta) {
        diaryViewMonth += delta;
        if (diaryViewMonth < 0) {
          diaryViewMonth = 11;
          diaryViewYear--;
        } else if (diaryViewMonth > 11) {
          diaryViewMonth = 0;
          diaryViewYear++;
        }
        // 월이 바뀌면 해당 월의 1일을 기본 선택
        diaryViewDay = 1;
        renderDiaryView(user);
      }

      /**
       * 다이어리 오늘 날짜로 복귀
       */
      function navigateDiaryToday(user) {
        const now = new Date();
        diaryViewYear  = now.getFullYear();
        diaryViewMonth = now.getMonth();
        diaryViewDay   = now.getDate();
        renderDiaryView(user);
      }

      // =========================================
      // 음력 근사 변환 (2024~2026년 범위)
      // =========================================

      /**
       * 양력 날짜를 음력 날짜로 근사 변환합니다.
       * 완전한 정확도보다 실용적인 근사치를 제공합니다.
       * 2024~2026년 범위를 커버하는 룩업 테이블 기반 방식입니다.
       * @param {number} year - 양력 연도
       * @param {number} month - 양력 월 (1-indexed)
       * @param {number} day - 양력 일
       * @returns {string} 음력 표시 문자열 (예: "음력 1월 15일")
       */
      function solarToLunar(year, month, day) {
        // 각 연도별 음력 1월 1일의 양력 날짜 (기준점)
        const lunarNewYearDates = {
          2024: new Date(2024, 1, 10),
          2025: new Date(2025, 0, 29),
          2026: new Date(2026, 1, 17),
          2027: new Date(2027, 1, 6),
        };

        // 각 연도의 음력 월별 일수
        const lunarMonthDays = {
          2024: [30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30],
          2025: [30, 29, 30, 29, 30, 29, 30, 30, 29, 30, 29, 30],
          2026: [29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 30, 29],
        };

        const target = new Date(year, month - 1, day);

        // 해당 날짜에 맞는 음력 기준 연도 찾기
        // 그 해 설날보다 앞이면 전년도 기준 사용
        const availableYears = [2024, 2025, 2026];
        let baseYear = null;
        for (let i = availableYears.length - 1; i >= 0; i--) {
          const y = availableYears[i];
          if (lunarNewYearDates[y] && target >= lunarNewYearDates[y]) {
            baseYear = y;
            break;
          }
        }

        if (!baseYear) return '';

        const baseDate = lunarNewYearDates[baseYear];
        let diffDays = Math.round((target - baseDate) / (1000 * 60 * 60 * 24));
        const monthDays = lunarMonthDays[baseYear];
        if (!monthDays) return '';

        let monthIdx = 0;
        while (monthIdx < monthDays.length && diffDays >= monthDays[monthIdx]) {
          diffDays -= monthDays[monthIdx];
          monthIdx++;
        }

        if (monthIdx >= monthDays.length) return '';

        const lunarMonth = monthIdx + 1;
        const lunarDay = diffDays + 1;

        return `음력 ${lunarMonth}월 ${lunarDay}일`;
      }

      // =========================================
      // 다이어리 뷰 렌더링
      // =========================================

      /**
       * 다이어리 뷰 전체를 렌더링합니다.
       * 상단 헤더 + 날짜 스트립 + 날짜 정보 + 시간대별 행을 생성합니다.
       * @param {{ id: string, grade: string, classNum: string, name: string }} user
       */
      function renderDiaryView(user) {
        const now = new Date();
        const realYear  = now.getFullYear();
        const realMonth = now.getMonth();
        const realDay   = now.getDate();

        const year  = diaryViewYear;
        const month = diaryViewMonth;
        const day   = diaryViewDay;
        const isCurrentMonth = (year === realYear && month === realMonth);
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // ─── 상단 헤더 설정 ───
        document.getElementById('diaryMonthNum').textContent = month + 1;
        document.getElementById('diaryMonthEng').textContent = monthEngNames[month];
        document.getElementById('diaryMonthYear').textContent = year;

        // "오늘" 버튼: 현재 월이면 숨김
        const btnToday = document.getElementById('btnDiaryToday');
        if (isCurrentMonth) {
          btnToday.classList.add('hidden');
        } else {
          btnToday.classList.remove('hidden');
        }

        // ─── 날짜 스트립 렌더링 ───
        renderDiaryDateStrip(user, year, month, day, daysInMonth, realYear, realMonth, realDay);

        // ─── 날짜 정보 영역 렌더링 ───
        renderDiaryDateInfo(year, month, day);

        // ─── 시간대별 행 렌더링 ───
        renderDiaryHourRows(user, year, month, day, isCurrentMonth, realYear, realMonth, realDay);

        // ─── 하단 한줄평 섹션 렌더링 ───
        renderDiaryReviewSection(user, year, month, day);
      }

      /**
       * 가로 날짜 스트립을 렌더링합니다.
       * 각 날짜 버튼 클릭 시 해당 날짜를 선택하고 시간대 행을 갱신합니다.
       */
      function renderDiaryDateStrip(user, year, month, selectedDay, daysInMonth, realYear, realMonth, realDay) {
        const dowKor = ['일', '월', '화', '수', '목', '금', '토'];
        const strip  = document.getElementById('diaryDateStrip');
        strip.innerHTML = '';

        for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dow     = dateObj.getDay(); // 0=일, 6=토
          const isToday = (year === realYear && month === realMonth && d === realDay);
          const isSel   = d === selectedDay;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'diary-date-btn';
          if (dow === 0) btn.classList.add('is-sun');
          if (dow === 6) btn.classList.add('is-sat');
          if (isToday)  btn.classList.add('is-today-date');
          if (isSel)    btn.classList.add('is-selected');

          btn.setAttribute('aria-label', `${month + 1}월 ${d}일 ${dowKor[dow]}요일`);
          btn.setAttribute('data-day', d);
          btn.innerHTML = `
            <span class="strip-dow">${dowKor[dow]}</span>
            <span class="strip-day">${d}</span>
          `;

          btn.addEventListener('click', () => {
            diaryViewDay = d;
            // 선택 스타일 갱신
            strip.querySelectorAll('.diary-date-btn').forEach(b => b.classList.remove('is-selected'));
            btn.classList.add('is-selected');
            // 날짜 정보 갱신
            renderDiaryDateInfo(year, month, d);
            // 시간대 행 갱신
            const isCurMonth = (year === realYear && month === realMonth);
            renderDiaryHourRows(user, year, month, d, isCurMonth, realYear, realMonth, realDay);
            // 한줄평 섹션 갱신
            renderDiaryReviewSection(user, year, month, d);
          });

          strip.appendChild(btn);
        }

        // 선택된 날짜 버튼이 보이도록 스크롤
        requestAnimationFrame(() => {
          const selBtn = strip.querySelector('.is-selected');
          if (selBtn) {
            selBtn.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
          }
        });
      }

      /**
       * 선택된 날짜의 요일·음력 정보 영역을 갱신합니다.
       */
      function renderDiaryDateInfo(year, month, day) {
        const dowKorFull = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const dateObj = new Date(year, month, day);
        const dow     = dateObj.getDay();

        const infoDay   = document.getElementById('diaryInfoDay');
        const infoDow   = document.getElementById('diaryInfoDow');
        const infoLunar = document.getElementById('diaryInfoLunar');

        infoDay.textContent = day;

        infoDow.textContent = dowKorFull[dow];
        infoDow.className   = 'info-dow';
        if (dow === 0) infoDow.classList.add('is-sun');
        if (dow === 6) infoDow.classList.add('is-sat');

        infoLunar.textContent = solarToLunar(year, month + 1, day);
      }

      /**
       * 시간대별 행(9시~24시)을 렌더링합니다.
       * 모든 날짜에서 인라인 입력 가능
       */
      function renderDiaryHourRows(user, year, month, day, isCurrentMonth, realYear, realMonth, realDay) {
        const container = document.getElementById('diaryHourRows');

        // dateKey = 'YYYY-MM-DD' (날짜 부분)
        const baseDateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // 해당 날짜의 시간대별 한줄평을 reviewMap으로 로드
        const reviews = getReviewsByUser(user.id);
        const hourReviewMap = {};
        reviews.forEach(r => {
          if (r.dateKey.startsWith(baseDateKey + '-')) {
            const hourPart = r.dateKey.slice(baseDateKey.length + 1);
            hourReviewMap[hourPart] = r;
          }
        });

        const startHour = 9;
        const endHour   = 24;
        let html = '';

        for (let h = startHour; h <= endHour; h++) {
          const hourStr   = String(h).padStart(2, '0');
          const hourKey   = baseDateKey + '-' + hourStr;
          const review    = hourReviewMap[hourStr] || null;
          const existingVal = review ? escapeHtml(review.content) : '';

          html += `
            <div class="diary-hour-row is-editable" data-hour="${hourStr}">
              <div class="hour-cell">${hourStr}</div>
              <div class="hour-content-cell">
                <input
                  type="text"
                  class="review-inline-input"
                  id="diaryInput-${hourStr}"
                  maxlength="100"
                  value="${existingVal}"
                />
              </div>
            </div>
          `;
        }

        container.innerHTML = html;

        // 모든 날짜에서 Enter 키 이벤트 바인딩
        for (let h = startHour; h <= endHour; h++) {
          const hourStr = String(h).padStart(2, '0');
          const hourKey = baseDateKey + '-' + hourStr;
          const input = document.getElementById(`diaryInput-${hourStr}`);
          if (input) {
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                handleDiaryHourSave(user, hourKey, hourStr, baseDateKey);
              }
            });
          }
        }
      }

      /**
       * 특정 시간대 한줄평 저장 핸들러
       * dateKey = 'YYYY-MM-DD-HH' 형식으로 저장합니다.
       * @param {{ id: string, name: string, grade: string, classNum: string }} user
       * @param {string} hourKey  - 'YYYY-MM-DD-HH' (저장용 dateKey)
       * @param {string} hourStr  - 'HH' (DOM ID 접미사)
       * @param {string} baseDateKey - 'YYYY-MM-DD' (시간대 행 재렌더링용)
       */
      function handleDiaryHourSave(user, hourKey, hourStr, baseDateKey) {
        const input = document.getElementById(`diaryInput-${hourStr}`);
        if (!input) return;

        const content = input.value.trim();
        if (!content) return;

        const result = upsertReview({
          userId:    user.id,
          userName:  user.name,
          userGrade: user.grade,
          userClass: user.classNum,
          dateKey:   hourKey,
          content:   content,
        });

        if (result.isUpdate) {
          showAlert('reviewWriteAlert', 'reviewWriteAlertIcon', 'reviewWriteAlertMsg', 'success', '✅', '수정되었습니다.');
        } else {
          showAlert('reviewWriteAlert', 'reviewWriteAlertIcon', 'reviewWriteAlertMsg', 'success', '✅', '등록되었습니다!');
        }
      }

      /**
       * 하단 한줄평 섹션을 렌더링합니다.
       * dateKey: 'YYYY-MM-DD' (일별 한줄평)
       */
      function renderDiaryReviewSection(user, year, month, day) {
        const container = document.getElementById('diaryReviewSection');
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const todayKey = getTodayKey();
        const isToday = dateKey === todayKey;
        const review = findReview(user.id, dateKey);
        const existingVal = review ? escapeHtml(review.content) : '';
        const hasComment = review && review.adminComment;

        let commentBtnHtml = '';
        if (hasComment) {
          commentBtnHtml = `<button class="btn-comment-view" id="btnViewComment" type="button">💬 코멘트</button>`;
        } else {
          commentBtnHtml = `<button class="btn-comment-view no-comment" type="button">💬 코멘트</button>`;
        }

        if (isToday) {
          // 오늘: 입력 가능
          container.innerHTML = `
            <div class="review-section-title">✏️ 오늘의 한줄평</div>
            <div class="diary-review-row">
              <input
                type="text"
                class="review-daily-input"
                id="diaryReviewInput"
                maxlength="100"
                placeholder="오늘 하루를 한 줄로 남겨보세요"
                value="${existingVal}"
              />
              <button type="button" class="btn-review-submit" id="btnSubmitReview">${review ? '수정' : '등록'}</button>
              ${commentBtnHtml}
            </div>
          `;

          // Enter 키로 저장
          const input = document.getElementById('diaryReviewInput');
          if (input) {
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                handleDailyReviewSave(user, dateKey, year, month, day);
              }
            });
          }

          // 등록 버튼 클릭으로 저장
          const btnSubmit = document.getElementById('btnSubmitReview');
          if (btnSubmit) {
            btnSubmit.addEventListener('click', () => {
              handleDailyReviewSave(user, dateKey, year, month, day);
            });
          }
        } else {
          // 다른 날: 읽기 전용
          const displayText = existingVal || '<span style="color:#d4c6e8; font-style:italic;">작성된 한줄평이 없습니다.</span>';
          container.innerHTML = `
            <div class="review-section-title">✏️ 한줄평</div>
            <div class="diary-review-row">
              <div class="review-daily-input" style="background:#f9f5ff; color:var(--color-text-primary); cursor:default;">${review ? escapeHtml(review.content) : '<span style="color:#d4c6e8; font-style:italic;">작성된 한줄평이 없습니다.</span>'}</div>
              ${commentBtnHtml}
            </div>
          `;
        }

        // 코멘트 버튼 이벤트
        if (hasComment) {
          const btnComment = document.getElementById('btnViewComment');
          btnComment.addEventListener('click', (e) => {
            e.stopPropagation();
            showCommentMemo(btnComment, review.adminComment, review.commentedAt);
          });
        }
      }

      /**
       * 일별 한줄평 저장 핸들러
       */
      function handleDailyReviewSave(user, dateKey, year, month, day) {
        const input = document.getElementById('diaryReviewInput');
        if (!input) return;

        const content = input.value.trim();
        if (!content) return;

        const result = upsertReview({
          userId:    user.id,
          userName:  user.name,
          userGrade: user.grade,
          userClass: user.classNum,
          dateKey:   dateKey,
          content:   content,
        });

        if (result.isUpdate) {
          showAlert('reviewWriteAlert', 'reviewWriteAlertIcon', 'reviewWriteAlertMsg', 'success', '✅', '한줄평이 수정되었습니다.');
        } else {
          showAlert('reviewWriteAlert', 'reviewWriteAlertIcon', 'reviewWriteAlertMsg', 'success', '✅', '한줄평이 등록되었습니다!');
        }

        // 코멘트 버튼 갱신
        renderDiaryReviewSection(user, year, month, day);
      }

      /**
       * 코멘트 메모지 팝오버를 표시합니다.
       */
      function showCommentMemo(anchorEl, comment, commentedAt) {
        // 기존 메모지 제거
        closeCommentMemo();

        const rect = anchorEl.getBoundingClientRect();

        // 오버레이 (클릭 시 닫기)
        const overlay = document.createElement('div');
        overlay.className = 'comment-memo-overlay';
        overlay.addEventListener('click', closeCommentMemo);

        // 메모지
        const memo = document.createElement('div');
        memo.className = 'comment-memo';

        // 날짜 포맷
        let dateStr = '';
        if (commentedAt) {
          const d = new Date(commentedAt);
          dateStr = `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
        }

        memo.innerHTML = `
          <div class="memo-label">📝 선생님 코멘트</div>
          <div class="memo-content">${escapeHtml(comment)}</div>
          ${dateStr ? `<div class="memo-date">${dateStr}</div>` : ''}
        `;

        // 위치 계산 (버튼 위에 표시)
        memo.style.top = (rect.top - 10) + 'px';
        memo.style.right = (window.innerWidth - rect.right) + 'px';
        memo.style.transform = 'translateY(-100%)';

        document.body.appendChild(overlay);
        document.body.appendChild(memo);

        // 화면 밖으로 나가면 아래로 표시
        requestAnimationFrame(() => {
          const memoRect = memo.getBoundingClientRect();
          if (memoRect.top < 10) {
            memo.style.top = (rect.bottom + 10) + 'px';
            memo.style.transform = 'none';
          }
        });
      }

      /**
       * 코멘트 메모지를 닫습니다.
       */
      function closeCommentMemo() {
        document.querySelectorAll('.comment-memo-overlay, .comment-memo').forEach(el => el.remove());
      }

      /**
       * 사용자 홈 탭 전환 함수
       * @param {'notice' | 'review'} tabName
       */
      function switchUserTab(tabName) {
        const tabNotice  = document.getElementById('tabNotice');
        const tabReview  = document.getElementById('tabReview');
        const contentNotice = document.getElementById('tabContentNotice');
        const contentReview = document.getElementById('tabContentReview');

        if (tabName === 'notice') {
          tabNotice.classList.add('active');
          tabNotice.setAttribute('aria-selected', 'true');
          tabReview.classList.remove('active');
          tabReview.setAttribute('aria-selected', 'false');
          contentNotice.classList.add('active');
          contentReview.classList.remove('active');
        } else {
          tabReview.classList.add('active');
          tabReview.setAttribute('aria-selected', 'true');
          tabNotice.classList.remove('active');
          tabNotice.setAttribute('aria-selected', 'false');
          contentReview.classList.add('active');
          contentNotice.classList.remove('active');
        }
      }

      // =========================================
      // 공지사항 UI 렌더링 (사용자 홈) — 다이어리 스타일
      // =========================================

      const monthEngNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      /**
       * 사용자 공지사항 전체 뷰를 렌더링합니다.
       */
      function renderUserNoticeCard(user) {
        const now = new Date();
        const realYear  = now.getFullYear();
        const realMonth = now.getMonth();
        const realDay   = now.getDate();

        const year  = noticeViewYear;
        const month = noticeViewMonth;
        const day   = noticeViewDay;
        const isCurrentMonth = (year === realYear && month === realMonth);
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 헤더 설정
        document.getElementById('noticeMonthNum').textContent = month + 1;
        document.getElementById('noticeMonthEng').textContent = monthEngNames[month];
        document.getElementById('noticeMonthYear').textContent = year;

        // "오늘" 버튼
        const btnToday = document.getElementById('btnNoticeToday');
        if (isCurrentMonth && day === realDay) {
          btnToday.classList.add('hidden');
        } else {
          btnToday.classList.remove('hidden');
        }

        // 날짜 스트립
        renderNoticeDateStrip(user, year, month, day, daysInMonth, realYear, realMonth, realDay);

        // 날짜 정보
        renderNoticeDateInfo(year, month, day);

        // 공지사항 내용
        renderNoticeContent(user, year, month, day, realYear, realMonth, realDay);
      }

      /**
       * 사용자 공지사항 날짜 스트립을 렌더링합니다.
       */
      function renderNoticeDateStrip(user, year, month, selectedDay, daysInMonth, realYear, realMonth, realDay) {
        const dowKor = ['일', '월', '화', '수', '목', '금', '토'];
        const strip  = document.getElementById('noticeDateStrip');
        strip.innerHTML = '';

        for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dow     = dateObj.getDay();
          const isToday = (year === realYear && month === realMonth && d === realDay);
          const isSel   = d === selectedDay;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'diary-date-btn';
          if (dow === 0) btn.classList.add('is-sun');
          if (dow === 6) btn.classList.add('is-sat');
          if (isToday)  btn.classList.add('is-today-date');
          if (isSel)    btn.classList.add('is-selected');

          btn.innerHTML = `
            <span class="strip-dow">${dowKor[dow]}</span>
            <span class="strip-day">${d}</span>
          `;

          btn.addEventListener('click', () => {
            noticeViewDay = d;
            strip.querySelectorAll('.diary-date-btn').forEach(b => b.classList.remove('is-selected'));
            btn.classList.add('is-selected');
            renderNoticeDateInfo(year, month, d);
            renderNoticeContent(user, year, month, d, realYear, realMonth, realDay);
            // "오늘" 버튼 갱신
            const btnT = document.getElementById('btnNoticeToday');
            if (year === realYear && month === realMonth && d === realDay) {
              btnT.classList.add('hidden');
            } else {
              btnT.classList.remove('hidden');
            }
          });

          strip.appendChild(btn);
        }

        requestAnimationFrame(() => {
          const selBtn = strip.querySelector('.is-selected');
          if (selBtn) selBtn.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
        });
      }

      /**
       * 사용자 공지사항 날짜 정보 영역을 갱신합니다.
       */
      function renderNoticeDateInfo(year, month, day) {
        const dowKorFull = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const dateObj = new Date(year, month, day);
        const dow = dateObj.getDay();

        document.getElementById('noticeInfoDay').textContent = day;

        const infoDow = document.getElementById('noticeInfoDow');
        infoDow.textContent = dowKorFull[dow];
        infoDow.className = 'info-dow';
        if (dow === 0) infoDow.classList.add('is-sun');
        if (dow === 6) infoDow.classList.add('is-sat');

        document.getElementById('noticeInfoLunar').textContent = solarToLunar(year, month + 1, day);
      }

      /**
       * 선택된 날짜의 공지사항 내용을 렌더링합니다.
       */
      function renderNoticeContent(user, year, month, day, realYear, realMonth, realDay) {
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const todayKey = getTodayKey();
        const isToday = dateKey === todayKey;

        const cardBody = document.getElementById('userNoticeCardBody');
        const notice = findNoticeByDate(dateKey);
        const dateLabel = formatDateKorean(dateKey);

        if (!notice) {
          cardBody.innerHTML = `
            <div class="notice-empty">
              <span class="notice-empty-icon">📭</span>
              ${escapeHtml(dateLabel)}의 공지사항이 없습니다.
            </div>
          `;
          return;
        }

        let confirmButtonHtml = '';
        if (isToday) {
          const alreadyRead = hasReadNotice(dateKey, user.id);
          confirmButtonHtml = alreadyRead
            ? `<div class="notice-read-badge" aria-label="공지사항 확인 완료">✅ 확인 완료</div>`
            : `<button class="btn btn--success btn--full" id="btnConfirmNotice" type="button">✔ 확인했습니다</button>`;
        }

        cardBody.innerHTML = `
          <div class="notice-content-box" aria-label="공지사항 내용">${escapeHtml(notice.content)}</div>
          ${confirmButtonHtml}
        `;

        if (isToday && !hasReadNotice(dateKey, user.id)) {
          const confirmBtn = document.getElementById('btnConfirmNotice');
          if (confirmBtn) {
            confirmBtn.addEventListener('click', () => handleConfirmNotice(user, dateKey));
          }
        }
      }

      /**
       * 사용자 공지사항 월 이동
       */
      function navigateNoticeMonth(user, delta) {
        noticeViewMonth += delta;
        if (noticeViewMonth < 0) {
          noticeViewMonth = 11;
          noticeViewYear--;
        } else if (noticeViewMonth > 11) {
          noticeViewMonth = 0;
          noticeViewYear++;
        }
        noticeViewDay = 1;
        renderUserNoticeCard(user);
      }

      /**
       * 사용자 공지사항 오늘로 이동
       */
      function navigateNoticeToday(user) {
        const now = new Date();
        noticeViewYear  = now.getFullYear();
        noticeViewMonth = now.getMonth();
        noticeViewDay   = now.getDate();
        renderUserNoticeCard(user);
      }

      /**
       * 사용자가 "확인했습니다" 버튼을 클릭했을 때 열람 기록을 남기고 UI를 갱신합니다.
       */
      function handleConfirmNotice(user, dateKey) {
        const success = markNoticeAsRead(dateKey, user);
        if (!success) {
          alert('열람 확인 처리에 실패했습니다. 다시 시도해주세요.');
          return;
        }
        renderUserNoticeCard(user);
      }

      // =========================================
      // 공지사항 UI 렌더링 (관리자 대시보드) — 다이어리 스타일
      // =========================================

      /** 관리자 공지사항에서 보고 있는 연/월/일 */
      let adminNoticeViewYear  = null;
      let adminNoticeViewMonth = null;
      let adminNoticeViewDay   = null;

      /**
       * 관리자 공지사항 작성 섹션을 초기화합니다.
       */
      function initAdminNoticeSection() {
        const now = new Date();
        adminNoticeViewYear  = now.getFullYear();
        adminNoticeViewMonth = now.getMonth();
        adminNoticeViewDay   = now.getDate();
        renderAdminNoticeSection();
      }

      /**
       * 관리자 공지사항 월 이동
       */
      function navigateAdminNoticeMonth(delta) {
        adminNoticeViewMonth += delta;
        if (adminNoticeViewMonth < 0) {
          adminNoticeViewMonth = 11;
          adminNoticeViewYear--;
        } else if (adminNoticeViewMonth > 11) {
          adminNoticeViewMonth = 0;
          adminNoticeViewYear++;
        }
        adminNoticeViewDay = 1;
        renderAdminNoticeSection();
      }

      /**
       * 관리자 공지사항 오늘로 이동
       */
      function navigateAdminNoticeToday() {
        const now = new Date();
        adminNoticeViewYear  = now.getFullYear();
        adminNoticeViewMonth = now.getMonth();
        adminNoticeViewDay   = now.getDate();
        renderAdminNoticeSection();
      }

      /**
       * 관리자 공지사항 섹션을 현재 선택 날짜 기준으로 렌더링합니다.
       */
      function renderAdminNoticeSection() {
        const now = new Date();
        const realYear  = now.getFullYear();
        const realMonth = now.getMonth();
        const realDay   = now.getDate();

        const year  = adminNoticeViewYear;
        const month = adminNoticeViewMonth;
        const day   = adminNoticeViewDay;
        const isCurrentMonth = (year === realYear && month === realMonth);
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 헤더 설정
        document.getElementById('adminNoticeMonthNum').textContent = month + 1;
        document.getElementById('adminNoticeMonthEng').textContent = monthEngNames[month];
        document.getElementById('adminNoticeMonthYear').textContent = year;

        // "오늘" 버튼
        const btnToday = document.getElementById('btnAdminNoticeToday');
        if (isCurrentMonth && day === realDay) {
          btnToday.classList.add('hidden');
        } else {
          btnToday.classList.remove('hidden');
        }

        // 날짜 스트립
        renderAdminNoticeDateStrip(year, month, day, daysInMonth, realYear, realMonth, realDay);

        // 날짜 정보
        renderAdminNoticeDateInfo(year, month, day);

        // 공지사항 작성 영역 갱신
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const textarea  = document.getElementById('noticeContentInput');
        const saveBtn   = document.getElementById('btnSaveNotice');
        const charCount = document.getElementById('noticeCharCount');

        const existing = findNoticeByDate(dateKey);
        if (existing) {
          textarea.value = existing.content;
          saveBtn.textContent = '공지사항 수정';
          updateNoticeCharCount(existing.content.length, charCount);
        } else {
          textarea.value = '';
          saveBtn.textContent = '공지사항 저장';
          updateNoticeCharCount(0, charCount);
        }

        hideAlert('noticeWriteAlert');
        renderNoticeReaderList(dateKey);
      }

      /**
       * 관리자 공지사항 날짜 스트립을 렌더링합니다.
       */
      function renderAdminNoticeDateStrip(year, month, selectedDay, daysInMonth, realYear, realMonth, realDay) {
        const dowKor = ['일', '월', '화', '수', '목', '금', '토'];
        const strip = document.getElementById('adminNoticeDateStrip');
        strip.innerHTML = '';

        for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dow = dateObj.getDay();
          const isToday = (year === realYear && month === realMonth && d === realDay);
          const isSel = d === selectedDay;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'diary-date-btn';
          if (dow === 0) btn.classList.add('is-sun');
          if (dow === 6) btn.classList.add('is-sat');
          if (isToday)  btn.classList.add('is-today-date');
          if (isSel)    btn.classList.add('is-selected');

          btn.innerHTML = `
            <span class="strip-dow">${dowKor[dow]}</span>
            <span class="strip-day">${d}</span>
          `;

          btn.addEventListener('click', () => {
            adminNoticeViewDay = d;
            strip.querySelectorAll('.diary-date-btn').forEach(b => b.classList.remove('is-selected'));
            btn.classList.add('is-selected');
            renderAdminNoticeDateInfo(year, month, d);
            // 공지사항 내용 갱신
            const dk = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const textarea  = document.getElementById('noticeContentInput');
            const saveBtn   = document.getElementById('btnSaveNotice');
            const charCount = document.getElementById('noticeCharCount');
            const ex = findNoticeByDate(dk);
            if (ex) {
              textarea.value = ex.content;
              saveBtn.textContent = '공지사항 수정';
              updateNoticeCharCount(ex.content.length, charCount);
            } else {
              textarea.value = '';
              saveBtn.textContent = '공지사항 저장';
              updateNoticeCharCount(0, charCount);
            }
            hideAlert('noticeWriteAlert');
            renderNoticeReaderList(dk);
            // "오늘" 버튼 갱신
            const btnT = document.getElementById('btnAdminNoticeToday');
            if (year === realYear && month === realMonth && d === realDay) {
              btnT.classList.add('hidden');
            } else {
              btnT.classList.remove('hidden');
            }
          });

          strip.appendChild(btn);
        }

        requestAnimationFrame(() => {
          const selBtn = strip.querySelector('.is-selected');
          if (selBtn) selBtn.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
        });
      }

      /**
       * 관리자 공지사항 날짜 정보 영역을 갱신합니다.
       */
      function renderAdminNoticeDateInfo(year, month, day) {
        const dowKorFull = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const dateObj = new Date(year, month, day);
        const dow = dateObj.getDay();

        document.getElementById('adminNoticeInfoDay').textContent = day;

        const infoDow = document.getElementById('adminNoticeInfoDow');
        infoDow.textContent = dowKorFull[dow];
        infoDow.className = 'info-dow';
        if (dow === 0) infoDow.classList.add('is-sun');
        if (dow === 6) infoDow.classList.add('is-sat');

        document.getElementById('adminNoticeInfoLunar').textContent = solarToLunar(year, month + 1, day);
      }

      /**
       * 공지사항 글자 수 카운터 UI를 갱신합니다.
       * @param {number} count
       * @param {HTMLElement} countEl
       */
      function updateNoticeCharCount(count, countEl) {
        countEl.textContent = `${count} / ${NOTICE_MAX_LENGTH}자`;
        countEl.classList.remove('near-limit', 'at-limit');
        if (count >= NOTICE_MAX_LENGTH) {
          countEl.classList.add('at-limit');
        } else if (count >= NOTICE_MAX_LENGTH * 0.8) {
          countEl.classList.add('near-limit');
        }
      }

      /**
       * 관리자 공지사항 저장 버튼 클릭을 처리합니다.
       */
      function handleSaveNotice() {
        const dateKey   = `${adminNoticeViewYear}-${String(adminNoticeViewMonth + 1).padStart(2, '0')}-${String(adminNoticeViewDay).padStart(2, '0')}`;
        const textarea  = document.getElementById('noticeContentInput');
        const saveBtn   = document.getElementById('btnSaveNotice');
        const content   = textarea.value.trim();

        if (!content) {
          shakeElement(textarea);
          showAlert('noticeWriteAlert', 'noticeWriteAlertIcon', 'noticeWriteAlertMsg', 'error', '⚠️', '공지사항 내용을 입력해주세요.');
          textarea.focus();
          return;
        }

        const result = upsertNotice(dateKey, content);

        if (result.isUpdate) {
          showAlert('noticeWriteAlert', 'noticeWriteAlertIcon', 'noticeWriteAlertMsg', 'success', '✅', '공지사항이 수정되었습니다.');
        } else {
          showAlert('noticeWriteAlert', 'noticeWriteAlertIcon', 'noticeWriteAlertMsg', 'success', '✅', '공지사항이 등록되었습니다!');
        }

        saveBtn.textContent = '공지사항 수정';

        renderNoticeReaderList(dateKey);
      }

      /**
       * 선택된 날짜의 공지사항 열람자 목록을 관리자 뷰에 렌더링합니다.
       * @param {string} dateKey - 'YYYY-MM-DD'
       */
      function renderNoticeReaderList(dateKey) {
        const container = document.getElementById('noticeReaderContainer');
        const notice    = findNoticeByDate(dateKey);
        const dateLabel = formatDateKorean(dateKey);

        // 공지사항 자체가 없는 경우
        if (!notice) {
          container.innerHTML = `
            <div class="reader-list-empty">
              ${escapeHtml(dateLabel)}에 작성된 공지사항이 없습니다.
            </div>
          `;
          return;
        }

        const readers      = notice.readers;
        const totalUsers   = loadUsersFromStorage().length;

        // 읽은 시각을 'HH:MM' 형식으로 변환하는 내부 헬퍼
        function formatReadTime(isoString) {
          const d = new Date(isoString);
          const h = String(d.getHours()).padStart(2, '0');
          const m = String(d.getMinutes()).padStart(2, '0');
          return `${h}:${m}`;
        }

        // 열람자를 학년 → 반 → 이름 순으로 정렬
        const sortedReaders = readers.slice().sort((a, b) => {
          const gradeDiff = Number(a.userGrade) - Number(b.userGrade);
          if (gradeDiff !== 0) return gradeDiff;
          const classDiff = Number(a.userClass) - Number(b.userClass);
          if (classDiff !== 0) return classDiff;
          return a.userName.localeCompare(b.userName);
        });

        // 요약 정보 구성
        const summaryHtml = `
          <div class="reader-summary">
            <span>확인 현황</span>
            <span class="reader-count-badge">${readers.length} / ${totalUsers}명</span>
          </div>
        `;

        // 열람자가 없는 경우
        if (readers.length === 0) {
          container.innerHTML = `
            ${summaryHtml}
            <div class="reader-list-empty">
              아직 공지사항을 확인한 학생이 없습니다.
            </div>
          `;
          return;
        }

        // 열람자 테이블 행 구성
        const rows = sortedReaders.map((reader, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(reader.userGrade)}학년</td>
            <td>${escapeHtml(reader.userClass)}반</td>
            <td>${escapeHtml(reader.userName)}</td>
            <td class="reader-time-cell">${escapeHtml(formatReadTime(reader.readAt))}</td>
          </tr>
        `).join('');

        container.innerHTML = `
          ${summaryHtml}
          <table class="reader-list-table" aria-label="공지사항 열람자 목록">
            <thead>
              <tr>
                <th>번호</th>
                <th>학년</th>
                <th>반</th>
                <th>이름</th>
                <th>확인 시간</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }

      /**
       * (하위 호환용) 기존 코드에서 호출될 수 있는 함수 스텁
       */
      function renderMyReviewList() {}
      function handleSubmitReview() {
        if (!currentUser) return;
        handleDiaryInlineSave(currentUser, getTodayKey(), new Date().getDate());
      }

      // =========================================
      // 관리자 로그인 핸들러
      // =========================================

      /**
       * 관리자 로그인 시도를 처리합니다.
       */
      function handleAdminLogin() {
        const passwordInput = document.getElementById('adminPasswordInput');
        const enteredPassword = passwordInput.value;

        if (!enteredPassword) {
          showAdminLoginError('비밀번호를 입력해주세요.');
          shakeElement(passwordInput);
          return;
        }

        if (enteredPassword !== ADMIN_PASSWORD) {
          showAdminLoginError('비밀번호가 올바르지 않습니다. 다시 시도해주세요.');
          passwordInput.value = '';
          shakeElement(passwordInput);
          passwordInput.focus();
          return;
        }

        // 로그인 성공
        document.getElementById('adminLoginError').style.display = 'none';
        passwordInput.value = '';
        navigateTo(SCREENS.ADMIN_DASHBOARD);
        renderDashboard();
      }

      /**
       * 관리자 로그인 에러 메시지를 표시합니다.
       * @param {string} message
       */
      function showAdminLoginError(message) {
        document.getElementById('adminLoginErrorMsg').textContent = message;
        document.getElementById('adminLoginError').style.display = 'flex';
      }

      // =========================================
      // 관리자 대시보드 핸들러
      // =========================================

      /**
       * 대시보드 전체를 현재 상태에 맞게 렌더링합니다.
       * 사용자 목록 + 공지사항 섹션 + 한줄평 관리 섹션을 모두 갱신합니다.
       */
      function renderDashboard() {
        // 고아 한줄평 정리 (사용자 목록에 없는 사용자의 한줄평 삭제)
        cleanOrphanReviews();
        renderUserList();
        initAdminNoticeSection();
        initAdminReviewSection();
        // 관리자 탭을 사용자 목록(기본)으로 초기화
        switchAdminTab('users');
      }

      /**
       * 사용자 목록에 없는 사용자의 한줄평을 삭제합니다.
       */
      function cleanOrphanReviews() {
        const users = loadUsersFromStorage();
        const userIds = new Set(users.map(u => u.id));
        const reviews = loadReviewsFromStorage();
        const cleaned = reviews.filter(r => r && userIds.has(r.userId));
        if (cleaned.length !== reviews.length) {
          saveReviewsToStorage(cleaned);
        }
      }

      /**
       * 특정 사용자의 비밀번호를 1234로 초기화합니다.
       */
      function resetUserPassword(userId) {
        const users = loadUsersFromStorage();
        const idx = users.findIndex(u => u.id === userId);
        if (idx === -1) return;
        users[idx].password = '1234';
        saveUsersToStorage(users);
        alert('비밀번호가 1234로 초기화되었습니다.');
        renderUserList();
      }

      /**
       * 특정 사용자를 삭제하고 관련 한줄평도 함께 삭제합니다.
       */
      function deleteUser(userId) {
        const users = loadUsersFromStorage().filter(u => u.id !== userId);
        saveUsersToStorage(users);
        const reviews = loadReviewsFromStorage().filter(r => r.userId !== userId);
        saveReviewsToStorage(reviews);
        renderUserList();
      }

      /**
       * 가입 사용자 목록 테이블을 렌더링합니다.
       * 학년 → 반 순으로 정렬하여 표시합니다.
       */
      function renderUserList() {
        const container  = document.getElementById('userListContainer');
        const countBadge = document.getElementById('userCountBadge');
        const sortedUsers = getSortedUsers();

        countBadge.textContent = `${sortedUsers.length}명`;

        if (sortedUsers.length === 0) {
          container.innerHTML = `
            <div class="user-list-empty">
              <span class="user-list-empty-icon">👥</span>
              아직 가입한 사용자가 없습니다.<br/>
              사용자가 회원가입하면 이곳에 표시됩니다.
            </div>
          `;
          return;
        }

        // 테이블 구성
        const rows = sortedUsers.map((user, index) => `
          <tr>
            <td>${index + 1}</td>
            <td>${escapeHtml(user.grade)}학년</td>
            <td>${escapeHtml(user.classNum)}반</td>
            <td>${escapeHtml(user.name)}</td>
            <td style="display:flex;gap:4px;"><button class="btn btn--warning btn--sm" type="button" onclick="if(confirm('${escapeAttr(user.name)} 학생의 비밀번호를 1234로 초기화할까요?')) resetUserPassword('${escapeAttr(user.id)}')" style="font-size:0.7rem;">PW초기화</button><button class="btn btn--danger btn--sm" type="button" onclick="if(confirm('${escapeAttr(user.name)} 학생을 삭제하시겠습니까?\\n한줄평 데이터도 함께 삭제됩니다.')) deleteUser('${escapeAttr(user.id)}')" style="font-size:0.7rem;">삭제</button></td>
          </tr>
        `).join('');

        container.innerHTML = `
          <table class="user-list-table" aria-label="가입 사용자 목록">
            <thead>
              <tr>
                <th>번호</th>
                <th>학년</th>
                <th>반</th>
                <th>이름</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }

      // =========================================
      // 관리자 한줄평 날짜 네비게이션
      // =========================================

      let adminReviewViewYear  = null;
      let adminReviewViewMonth = null;
      let adminReviewViewDay   = null;

      /**
       * 관리자 한줄평 관리 섹션 초기화.
       * 날짜를 오늘로 설정하고 다이어리 스타일로 렌더링합니다.
       */
      function initAdminReviewSection() {
        const now = new Date();
        adminReviewViewYear  = now.getFullYear();
        adminReviewViewMonth = now.getMonth();
        adminReviewViewDay   = now.getDate();
        renderAdminReviewSection();
      }

      /**
       * 관리자 한줄평 월 이동
       */
      function navigateAdminReviewMonth(delta) {
        adminReviewViewMonth += delta;
        if (adminReviewViewMonth < 0) {
          adminReviewViewMonth = 11;
          adminReviewViewYear--;
        } else if (adminReviewViewMonth > 11) {
          adminReviewViewMonth = 0;
          adminReviewViewYear++;
        }
        adminReviewViewDay = 1;
        renderAdminReviewSection();
      }

      /**
       * 관리자 한줄평 오늘로 이동
       */
      function navigateAdminReviewToday() {
        const now = new Date();
        adminReviewViewYear  = now.getFullYear();
        adminReviewViewMonth = now.getMonth();
        adminReviewViewDay   = now.getDate();
        renderAdminReviewSection();
      }

      /**
       * 관리자 한줄평 섹션 전체 렌더링 (다이어리 스타일)
       */
      function renderAdminReviewSection() {
        const now = new Date();
        const realYear  = now.getFullYear();
        const realMonth = now.getMonth();
        const realDay   = now.getDate();

        const year  = adminReviewViewYear;
        const month = adminReviewViewMonth;
        const day   = adminReviewViewDay;
        const isCurrentMonth = (year === realYear && month === realMonth);
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 헤더 설정
        document.getElementById('adminReviewMonthNum').textContent = month + 1;
        document.getElementById('adminReviewMonthEng').textContent = monthEngNames[month];
        document.getElementById('adminReviewMonthYear').textContent = year;

        // "오늘" 버튼
        const btnToday = document.getElementById('btnAdminReviewToday');
        if (isCurrentMonth && day === realDay) {
          btnToday.classList.add('hidden');
        } else {
          btnToday.classList.remove('hidden');
        }

        // 날짜 스트립
        renderAdminReviewDateStrip(year, month, day, daysInMonth, realYear, realMonth, realDay);

        // 날짜 정보
        renderAdminReviewDateInfo(year, month, day);

        // 한줄평 목록 갱신
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        document.getElementById('adminReviewDateFilter').value = dateKey;
        renderAdminReviewList(dateKey);
      }

      /**
       * 관리자 한줄평 날짜 스트립 렌더링
       */
      function renderAdminReviewDateStrip(year, month, selectedDay, daysInMonth, realYear, realMonth, realDay) {
        const dowKor = ['일', '월', '화', '수', '목', '금', '토'];
        const strip = document.getElementById('adminReviewDateStrip');
        strip.innerHTML = '';

        for (let d = 1; d <= daysInMonth; d++) {
          const dateObj = new Date(year, month, d);
          const dow = dateObj.getDay();
          const isToday = (year === realYear && month === realMonth && d === realDay);
          const isSel = d === selectedDay;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'diary-date-btn';
          if (dow === 0) btn.classList.add('is-sun');
          if (dow === 6) btn.classList.add('is-sat');
          if (isToday)  btn.classList.add('is-today-date');
          if (isSel)    btn.classList.add('is-selected');

          btn.innerHTML = `
            <span class="strip-dow">${dowKor[dow]}</span>
            <span class="strip-day">${d}</span>
          `;

          btn.addEventListener('click', () => {
            adminReviewViewDay = d;
            strip.querySelectorAll('.diary-date-btn').forEach(b => b.classList.remove('is-selected'));
            btn.classList.add('is-selected');
            renderAdminReviewDateInfo(year, month, d);
            const dk = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            document.getElementById('adminReviewDateFilter').value = dk;
            renderAdminReviewList(dk);
          });

          strip.appendChild(btn);
        }

        // 선택된 날짜 버튼이 보이도록 스크롤
        requestAnimationFrame(() => {
          const selBtn = strip.querySelector('.is-selected');
          if (selBtn) {
            selBtn.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
          }
        });
      }

      /**
       * 관리자 한줄평 선택 날짜 정보 렌더링
       */
      function renderAdminReviewDateInfo(year, month, day) {
        const dowKor = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        const dateObj = new Date(year, month, day);
        const dow = dateObj.getDay();

        document.getElementById('adminReviewInfoDay').textContent = day;
        const dowEl = document.getElementById('adminReviewInfoDow');
        dowEl.textContent = dowKor[dow];
        dowEl.className = 'info-dow';
        if (dow === 0) dowEl.classList.add('is-sun');
        if (dow === 6) dowEl.classList.add('is-sat');

        document.getElementById('adminReviewInfoLunar').textContent = solarToLunar(year, month + 1, day);
      }

      /**
       * 특정 날짜의 한줄평 목록을 관리자 뷰에 렌더링합니다.
       * 각 항목에는 학년/반/이름, 한줄평 내용, 기존 평가 (있으면), 평가 입력창이 표시됩니다.
       * @param {string} dateKey - 'YYYY-MM-DD'
       */
      function renderAdminReviewList(dateKey) {
        const container  = document.getElementById('adminReviewListContainer');
        const countBadge = document.getElementById('adminReviewCountBadge');
        const dateLabel  = document.getElementById('adminReviewDateLabel');

        dateLabel.textContent = `${formatDateKorean(dateKey)} 한줄평`;

        // 일별 한줄평만 표시 (시간표 데이터 제외 + 사용자당 중복 제거)
        const allData = loadReviewsFromStorage();
        const seen = new Set();
        const reviews = allData
          .filter((r) => r && r.dateKey === dateKey)
          .filter((r) => {
            const key = r.userId + '_' + r.dateKey;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
          })
          .sort((a, b) => {
            const gradeDiff = Number(a.userGrade) - Number(b.userGrade);
            if (gradeDiff !== 0) return gradeDiff;
            const classDiff = Number(a.userClass) - Number(b.userClass);
            if (classDiff !== 0) return classDiff;
            return a.userName.localeCompare(b.userName);
          });
        countBadge.textContent = `${reviews.length}건`;

        if (reviews.length === 0) {
          container.innerHTML = `
            <div class="admin-review-empty">
              <span class="admin-review-empty-icon">📭</span>
              해당 날짜에 작성된 한줄평이 없습니다.
            </div>
          `;
          return;
        }

        const items = reviews.map((review) => {
          // 기존 평가 코멘트 영역
          const existingCommentHtml = review.adminComment
            ? `
              <div class="existing-comment-box" id="existingComment-${escapeHtml(review.id)}">
                <span class="existing-comment-label">현재 평가</span>
                <span class="existing-comment-text">${escapeHtml(review.adminComment)}</span>
              </div>
            `
            : '';

          return `
            <div class="admin-review-item">
              <div class="admin-review-item-header">
                <span class="admin-review-user-badge">
                  ${escapeHtml(review.userGrade)}학년 ${escapeHtml(review.userClass)}반 ${escapeHtml(review.userName)}
                </span>
              </div>
              <div class="admin-review-item-body">
                <div class="admin-review-content">${escapeHtml(review.content)}</div>
                ${existingCommentHtml}
                <div class="admin-comment-input-row">
                  <input
                    type="text"
                    class="form-input"
                    id="commentInput-${escapeHtml(review.id)}"
                    placeholder="${review.adminComment ? '평가를 수정하세요' : '평가 코멘트를 입력하세요'}"
                    maxlength="150"
                    value="${escapeHtml(review.adminComment)}"
                    aria-label="${escapeHtml(review.userName)} 학생 한줄평 평가 입력"
                  />
                  <button
                    class="btn btn--success btn--sm"
                    type="button"
                    onclick="handleSaveAdminComment('${escapeHtml(review.id)}', '${escapeAttr(dateKey)}')"
                    aria-label="평가 저장"
                  >
                    저장
                  </button>
                </div>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = `<div class="admin-review-list">${items}</div>`;
      }

      /**
       * 관리자가 특정 한줄평에 평가 코멘트를 저장하는 핸들러입니다.
       * 인라인 onclick에서 호출됩니다.
       * @param {string} reviewId
       * @param {string} dateKey - 목록 재렌더링을 위해 현재 날짜 유지
       */
      function handleSaveAdminComment(reviewId, dateKey) {
        const input   = document.getElementById(`commentInput-${reviewId}`);
        const comment = input ? input.value : '';

        const success = saveAdminComment(reviewId, comment);
        if (!success) {
          alert('저장에 실패했습니다. 다시 시도해주세요.');
          return;
        }

        // 목록 갱신 (저장 후 현재 날짜 필터 유지)
        renderAdminReviewList(dateKey);
      }

      /**
       * HTML 속성에 삽입할 때 추가로 홑따옴표를 이스케이프합니다.
       * onclick="..." 속성 내 문자열 인자용으로 사용합니다.
       * @param {string} str
       * @returns {string}
       */
      function escapeAttr(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/'/g, '&#39;')
          .replace(/"/g, '&quot;');
      }

      /**
       * XSS 방지를 위해 HTML 특수문자를 이스케이프합니다.
       * @param {string} str
       * @returns {string}
       */
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      /**
       * 관리자 로그아웃을 처리합니다.
       */
      function handleAdminLogout() {
        navigateTo(SCREENS.MAIN);
      }

      /**
       * 관리자 대시보드 탭 전환 함수
       * @param {'users' | 'notice' | 'review'} tabName
       */
      function switchAdminTab(tabName) {
        const tabs = {
          users:  { tab: 'adminTabUsers',  content: 'adminTabContentUsers' },
          notice: { tab: 'adminTabNotice', content: 'adminTabContentNotice' },
          review: { tab: 'adminTabReview', content: 'adminTabContentReview' },
        };

        Object.values(tabs).forEach(({ tab, content }) => {
          document.getElementById(tab).classList.remove('active');
          document.getElementById(tab).setAttribute('aria-selected', 'false');
          document.getElementById(content).classList.remove('active');
        });

        const active = tabs[tabName];
        document.getElementById(active.tab).classList.add('active');
        document.getElementById(active.tab).setAttribute('aria-selected', 'true');
        document.getElementById(active.content).classList.add('active');
      }

      // =========================================
      // 앱 초기화
      // =========================================

      // =========================================
      // Firebase 리스너 (실시간 동기화)
      // =========================================

      /**
       * Firebase Realtime Database 리스너를 설정합니다.
       * 다른 기기에서 데이터가 변경되면 캐시를 갱신하고 현재 화면을 다시 렌더링합니다.
       */
      /**
       * Firebase snap.val() 결과를 안전하게 배열로 변환합니다.
       * Firebase는 배열을 객체(인덱스 키)로 반환할 수 있기 때문입니다.
       */
      function toArray(val) {
        if (!val) return [];
        if (Array.isArray(val)) return val;
        // 객체인 경우 값만 추출하여 배열로 변환
        return Object.values(val);
      }

      function initFirebaseListeners() {
        db.ref('users').on('value', snap => {
          _usersCache = toArray(snap.val());
          // 관리자 대시보드에서 사용자 목록 실시간 갱신
          if (_currentScreen === SCREENS.ADMIN_DASHBOARD) {
            try { renderUserList(); } catch(e) {}
          }
        });

        db.ref('notices').on('value', snap => {
          _noticesCache = toArray(snap.val());
          // 사용자 홈에서 공지사항 실시간 갱신
          if (_currentScreen === SCREENS.USER_HOME && currentUser) {
            try { renderUserNoticeCard(currentUser); } catch(e) {}
          }
          // 관리자 대시보드에서 공지사항 실시간 갱신
          if (_currentScreen === SCREENS.ADMIN_DASHBOARD) {
            try { renderAdminNoticeSection(); } catch(e) {}
          }
        });

        db.ref('reviews').on('value', snap => {
          _reviewsCache = toArray(snap.val());
          // 사용자 홈에서 한줄평 실시간 갱신
          if (_currentScreen === SCREENS.USER_HOME && currentUser) {
            try { renderDiaryView(currentUser); } catch(e) {}
          }
          // 관리자 대시보드에서 한줄평 실시간 갱신
          if (_currentScreen === SCREENS.ADMIN_DASHBOARD) {
            try {
              const dateKey = document.getElementById('adminReviewDateFilter').value;
              if (dateKey) renderAdminReviewList(dateKey);
            } catch(e) {}
          }
        });
      }

      /**
       * Firebase에서 초기 데이터를 한 번 로드한 뒤 앱을 시작합니다.
       * 기존 localStorage 데이터가 있으면 Firebase로 마이그레이션합니다.
       */
      async function initFirebaseData() {
        try {
          const [usersSnap, noticesSnap, reviewsSnap] = await Promise.all([
            db.ref('users').once('value'),
            db.ref('notices').once('value'),
            db.ref('reviews').once('value'),
          ]);

          _usersCache   = toArray(usersSnap.val());
          _noticesCache  = toArray(noticesSnap.val());
          _reviewsCache  = toArray(reviewsSnap.val());

          // 관리자 비밀번호 로드
          const adminPwSnap = await db.ref('adminPassword').once('value');
          if (adminPwSnap.val()) {
            ADMIN_PASSWORD = adminPwSnap.val();
          }

          // localStorage에 데이터가 있고 Firebase가 비어있으면 마이그레이션
          if (_usersCache.length === 0) {
            try {
              const localUsers = JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '[]');
              if (localUsers.length > 0) {
                _usersCache = localUsers;
                await db.ref('users').set(localUsers);
              }
            } catch(e) {}
          }
          if (_noticesCache.length === 0) {
            try {
              const localNotices = JSON.parse(localStorage.getItem(NOTICES_STORAGE_KEY) || '[]');
              if (localNotices.length > 0) {
                _noticesCache = localNotices;
                await db.ref('notices').set(localNotices);
              }
            } catch(e) {}
          }
          if (_reviewsCache.length === 0) {
            try {
              const localReviews = JSON.parse(localStorage.getItem(REVIEWS_STORAGE_KEY) || '[]');
              if (localReviews.length > 0) {
                _reviewsCache = localReviews;
                await db.ref('reviews').set(localReviews);
              }
            } catch(e) {}
          }

          _firebaseReady = true;
        } catch (err) {
          console.warn('Firebase 초기 로드 실패, localStorage 폴백:', err);
          // Firebase 연결 실패 시 localStorage에서 로드
          try { _usersCache = JSON.parse(localStorage.getItem(USERS_STORAGE_KEY) || '[]'); } catch(e) { _usersCache = []; }
          try { _noticesCache = JSON.parse(localStorage.getItem(NOTICES_STORAGE_KEY) || '[]'); } catch(e) { _noticesCache = []; }
          try { _reviewsCache = JSON.parse(localStorage.getItem(REVIEWS_STORAGE_KEY) || '[]'); } catch(e) { _reviewsCache = []; }
          _firebaseReady = true;
        }
      }

      /**
       * 앱 전체의 이벤트 리스너를 등록하고 초기 화면을 설정합니다.
       */
      function initApp() {

        // role-card(div)에 클릭 + 키보드(Enter/Space) 접근성을 함께 등록하는 헬퍼
        function addRoleCardListeners(elementId, handler) {
          const el = document.getElementById(elementId);
          if (!el) return;
          el.addEventListener('click', handler);
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handler();
            }
          });
        }

        // --- 메인 화면 ---
        addRoleCardListeners('btnGoAdminLogin', () => {
          document.getElementById('adminLoginError').style.display = 'none';
          document.getElementById('adminPasswordInput').value = '';
          navigateTo(SCREENS.ADMIN_LOGIN);
          requestAnimationFrame(() => document.getElementById('adminPasswordInput').focus());
        });

        addRoleCardListeners('btnGoUserLogin', () => {
          resetUserLoginForm();
          navigateTo(SCREENS.USER_LOGIN);
          requestAnimationFrame(() => document.getElementById('userLoginName').focus());
        });

        addRoleCardListeners('btnGoRegister', () => {
          resetRegisterForm();
          navigateTo(SCREENS.REGISTER);
          requestAnimationFrame(() => document.getElementById('registerGrade').focus());
        });

        // --- 회원가입 화면 ---
        document.getElementById('btnBackFromRegister').addEventListener('click', () => {
          navigateTo(SCREENS.MAIN);
        });
        document.getElementById('btnRegisterSubmit').addEventListener('click', handleRegisterSubmit);
        // 비밀번호 확인 입력에서 Enter 누르면 제출
        document.getElementById('registerPasswordConfirm').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') handleRegisterSubmit();
        });
        // 회원가입 화면 → 로그인으로 이동 링크
        document.getElementById('btnGoUserLoginFromRegister').addEventListener('click', () => {
          resetUserLoginForm();
          navigateTo(SCREENS.USER_LOGIN);
          requestAnimationFrame(() => document.getElementById('userLoginName').focus());
        });

        // --- 사용자 로그인 화면 ---
        document.getElementById('btnBackFromUserLogin').addEventListener('click', () => {
          navigateTo(SCREENS.MAIN);
        });
        document.getElementById('btnUserLoginSubmit').addEventListener('click', handleUserLoginSubmit);
        document.getElementById('userLoginPassword').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') handleUserLoginSubmit();
        });
        // 로그인 화면 → 회원가입으로 이동 링크
        document.getElementById('btnGoRegisterFromLogin').addEventListener('click', () => {
          resetRegisterForm();
          navigateTo(SCREENS.REGISTER);
          requestAnimationFrame(() => document.getElementById('registerGrade').focus());
        });

        // --- 사용자 홈 화면 ---
        document.getElementById('btnChangePw').addEventListener('click', () => {
          if (!currentUser) return;
          const newPw = prompt('새 비밀번호를 입력하세요 (4자 이상):');
          if (!newPw) return;
          if (newPw.length < 4) {
            alert('비밀번호는 4자 이상이어야 합니다.');
            return;
          }
          const users = loadUsersFromStorage();
          const idx = users.findIndex(u => u.id === currentUser.id);
          if (idx === -1) return;
          users[idx].password = newPw;
          currentUser.password = newPw;
          saveUsersToStorage(users);
          alert('비밀번호가 변경되었습니다!');
        });

        document.getElementById('btnUserLogout').addEventListener('click', () => {
          currentUser = null;
          navigateTo(SCREENS.MAIN);
        });

        // 우리반(홈) 버튼 — 공지사항 탭으로 이동
        document.getElementById('btnNavHome').addEventListener('click', () => {
          switchUserTab('notice');
        });

        // 탭 네비게이션 이벤트
        document.getElementById('tabNotice').addEventListener('click', () => switchUserTab('notice'));
        document.getElementById('tabReview').addEventListener('click', () => switchUserTab('review'));

        // 공지사항 월 네비게이션
        document.getElementById('btnNoticeMonthPrev').addEventListener('click', () => {
          if (currentUser) navigateNoticeMonth(currentUser, -1);
        });
        document.getElementById('btnNoticeMonthNext').addEventListener('click', () => {
          if (currentUser) navigateNoticeMonth(currentUser, 1);
        });
        document.getElementById('btnNoticeToday').addEventListener('click', () => {
          if (currentUser) navigateNoticeToday(currentUser);
        });

        // 다이어리 월 네비게이션 버튼
        document.getElementById('btnDiaryPrev').addEventListener('click', () => {
          if (currentUser) navigateDiaryMonth(currentUser, -1);
        });
        document.getElementById('btnDiaryNext').addEventListener('click', () => {
          if (currentUser) navigateDiaryMonth(currentUser, 1);
        });
        document.getElementById('btnDiaryToday').addEventListener('click', () => {
          if (currentUser) navigateDiaryToday(currentUser);
        });

        // --- 관리자 로그인 화면 ---
        document.getElementById('btnAdminLogin').addEventListener('click', handleAdminLogin);
        document.getElementById('adminPasswordInput').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') handleAdminLogin();
        });
        document.getElementById('btnBackFromAdminLogin').addEventListener('click', () => {
          navigateTo(SCREENS.MAIN);
        });

        // 비밀번호 찾기 토글
        document.getElementById('btnAdminForgotPw').addEventListener('click', () => {
          const form = document.getElementById('adminResetPwForm');
          form.style.display = form.style.display === 'none' ? 'block' : 'none';
          document.getElementById('adminResetAlert').style.display = 'none';
        });

        // 비밀번호 초기화 실행
        document.getElementById('btnAdminResetPw').addEventListener('click', async () => {
          const name = document.getElementById('resetAdminName').value.trim();
          const birth = document.getElementById('resetAdminBirth').value;
          const phone = document.getElementById('resetAdminPhone').value.trim();

          const alertEl = document.getElementById('adminResetAlert');
          const alertMsg = document.getElementById('adminResetAlertMsg');

          if (!name || !birth || !phone) {
            alertEl.className = 'alert alert--error';
            alertEl.style.display = 'flex';
            alertMsg.textContent = '모든 항목을 입력해주세요.';
            return;
          }

          // Firebase에서 관리자 정보 가져와서 비교
          try {
            const snap = await db.ref('adminProfile').once('value');
            const data = snap.val();

            if (!data || !data.name || !data.birth || !data.phone) {
              alertEl.className = 'alert alert--error';
              alertEl.style.display = 'flex';
              alertMsg.textContent = '관리자 정보가 등록되지 않았습니다. 비밀번호 초기화가 불가능합니다.';
              return;
            }

            if (data.name !== name || data.birth !== birth || data.phone !== phone) {
              alertEl.className = 'alert alert--error';
              alertEl.style.display = 'flex';
              alertMsg.textContent = '입력한 정보가 일치하지 않습니다.';
              return;
            }

            // 일치 → 비밀번호 초기화
            ADMIN_PASSWORD = 'admin1234';
            await db.ref('adminPassword').set('admin1234');

            alertEl.className = 'alert alert--success';
            alertEl.innerHTML = '<span class="alert-icon">✅</span><span id="adminResetAlertMsg">비밀번호가 admin1234로 초기화되었습니다!</span>';
            alertEl.style.display = 'flex';

            // 입력 필드 초기화
            document.getElementById('resetAdminName').value = '';
            document.getElementById('resetAdminBirth').value = '';
            document.getElementById('resetAdminPhone').value = '';
          } catch (err) {
            alertEl.className = 'alert alert--error';
            alertEl.style.display = 'flex';
            alertMsg.textContent = '서버 오류가 발생했습니다. 다시 시도해주세요.';
          }
        });

        // --- 관리자 대시보드 ---
        // 관리자 드롭다운 토글
        const adminDropdownBtn = document.getElementById('btnAdminDropdown');
        const adminDropdownMenu = document.getElementById('adminDropdownMenu');
        adminDropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = adminDropdownMenu.classList.toggle('open');
          adminDropdownBtn.classList.toggle('open', isOpen);
        });
        document.addEventListener('click', () => {
          adminDropdownMenu.classList.remove('open');
          adminDropdownBtn.classList.remove('open');
        });

        // 드롭다운: 관리자 정보
        document.getElementById('btnAdminDropdownProfile').addEventListener('click', () => {
          adminDropdownMenu.classList.remove('open');
          adminDropdownBtn.classList.remove('open');
          const panel = document.getElementById('adminProfilePanel');
          // Firebase에서 관리자 정보 불러오기
          db.ref('adminProfile').once('value').then(snap => {
            const data = snap.val() || {};
            document.getElementById('adminProfileName').value = data.name || '';
            document.getElementById('adminProfileBirth').value = data.birth || '';
            document.getElementById('adminProfilePhone').value = data.phone || '';
          });
          panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        });

        // 관리자 정보 패널 닫기
        document.getElementById('btnCloseAdminProfile').addEventListener('click', () => {
          document.getElementById('adminProfilePanel').style.display = 'none';
        });

        // 관리자 정보 저장
        document.getElementById('btnSaveAdminProfile').addEventListener('click', () => {
          const name = document.getElementById('adminProfileName').value.trim();
          const birth = document.getElementById('adminProfileBirth').value;
          const phone = document.getElementById('adminProfilePhone').value.trim();
          db.ref('adminProfile').set({ name, birth, phone });
          alert('관리자 정보가 저장되었습니다!');
          document.getElementById('adminProfilePanel').style.display = 'none';
        });

        // 드롭다운: 비밀번호 변경
        document.getElementById('btnAdminDropdownChangePw').addEventListener('click', () => {
          adminDropdownMenu.classList.remove('open');
          adminDropdownBtn.classList.remove('open');
          const newPw = prompt('새 관리자 비밀번호를 입력하세요 (4자 이상):');
          if (!newPw) return;
          if (newPw.length < 4) {
            alert('비밀번호는 4자 이상이어야 합니다.');
            return;
          }
          ADMIN_PASSWORD = newPw;
          db.ref('adminPassword').set(newPw);
          alert('관리자 비밀번호가 변경되었습니다!');
        });

        document.getElementById('btnAdminLogout').addEventListener('click', handleAdminLogout);

        // 관리자 탭 네비게이션 이벤트
        document.getElementById('btnAdminNavHome').addEventListener('click', () => switchAdminTab('users'));
        document.getElementById('adminTabUsers').addEventListener('click', () => switchAdminTab('users'));
        document.getElementById('adminTabNotice').addEventListener('click', () => switchAdminTab('notice'));
        document.getElementById('adminTabReview').addEventListener('click', () => switchAdminTab('review'));

        // 관리자 공지사항 월 네비게이션
        document.getElementById('btnAdminNoticeMonthPrev').addEventListener('click', () => {
          navigateAdminNoticeMonth(-1);
        });
        document.getElementById('btnAdminNoticeMonthNext').addEventListener('click', () => {
          navigateAdminNoticeMonth(1);
        });
        document.getElementById('btnAdminNoticeToday').addEventListener('click', () => {
          navigateAdminNoticeToday();
        });

        // 공지사항 저장 버튼
        document.getElementById('btnSaveNotice').addEventListener('click', handleSaveNotice);

        // 공지사항 입력 글자 수 실시간 카운트
        document.getElementById('noticeContentInput').addEventListener('input', (e) => {
          const charCount = document.getElementById('noticeCharCount');
          updateNoticeCharCount(e.target.value.length, charCount);
        });

        // 관리자 한줄평 월 네비게이션
        document.getElementById('btnAdminReviewMonthPrev').addEventListener('click', () => {
          navigateAdminReviewMonth(-1);
        });
        document.getElementById('btnAdminReviewMonthNext').addEventListener('click', () => {
          navigateAdminReviewMonth(1);
        });
        document.getElementById('btnAdminReviewToday').addEventListener('click', () => {
          navigateAdminReviewToday();
        });

        // --- 초기 화면: 메인(역할 선택) ---
        navigateTo(SCREENS.MAIN);
      }

      // DOM이 완전히 로드된 후 Firebase 데이터 로드 → 앱 초기화 실행
      document.addEventListener('DOMContentLoaded', async () => {
        // 로딩 표시
        const container = document.getElementById('appContainer');
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'firebaseLoading';
        loadingDiv.style.cssText = 'text-align:center;padding:60px 20px;color:var(--color-text-secondary);font-size:1.1rem;';
        loadingDiv.innerHTML = '🌸 데이터를 불러오는 중...';
        container.prepend(loadingDiv);

        // Firebase 데이터 로드
        await initFirebaseData();

        // 로딩 화면 제거
        const loadEl = document.getElementById('firebaseLoading');
        if (loadEl) loadEl.remove();

        // 앱 초기화 (이벤트 리스너 등록 + 초기 화면)
        initApp();

        // Firebase 실시간 리스너 시작
        initFirebaseListeners();
      });
    </script>
  </body>
</html>
